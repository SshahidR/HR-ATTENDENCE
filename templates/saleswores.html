{% extends "base_sale.html" %}
{% load static %}
{% block content %}
{% include 'invoice/pdf/pickslip.html' %}

<script>
    if (!Number.prototype.toFixedRound) {
       Object.defineProperty(Number.prototype, 'toFixedRound', {
          value(precision) {
             var base = 10 ** precision;
             return (Math.round(this * base) / base).toFixed(precision);
          },
       })
    }

    
</script>
<style>
        [contenteditable=true]:empty:not(:focus):before{
        content:attr(data-ph);
        color:black;
        /* font-style:italic; */
    }
    .editable-td{
        background-color: #ffffb5;
    }
    .special-td{
        background-color: #ec9b58;
    }
    #items-entry-tbl > tfoot:nth-child(1) > tr > td:nth-child(12)::after{
            content: "%";
    }

    .ui-widget {
        font-family: unset !important;
        font-size: 0.95em !important;
    }

</style>
<style>
.suwala-doubleScroll-scroll-wrapper{
    width: 100% !important;
}


.ui-autocomplete-loading { background:url(http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.2/themes/smoothness/images/ui-anim_basic_16x16.gif) no-repeat right center }

.ui-autocomplete {
  overflow: auto;
  max-height: 300px;
}

.table-responsive{
    overflow:unset !important;
}

#sp_products td{
    padding: 1px;
    margin: 0px;
}

#products > tbody > tr > td:nth-child(9) {
    background-color: lightgreen !important;
}

/*#sp_products > tbody > tr > td:nth-child(9) {
    background-color: lightgreen !important;
}

#sp_products > tbody > tr > td:nth-child(1) {
    contenteditable: true;
}*/

/* approver history workflow */
#search-tbl{


    text-align: center;

}


.popover-header{


    background: rgb(255, 214, 204);
    color: black;


}


#blink-bg{
		color: #fff;
		padding: 10px;
		display: inline-block;
		border-radius: 5px;
		animation: blinkingBackground 2s infinite;
	}
	@keyframes blinkingBackground{
		0%		{ background-color: #10c018;}
		25%		{ background-color: #1056c0;}
		50%		{ background-color: #ef0a1a;}
		75%		{ background-color: #254878;}
		100%	        { background-color: #04a1d5;}
	}


#customer_receipt
{
  /*   height: 250px;
    overflow: scroll;
 */
}
body {
    background-color: #eee
}

.mt-70 {
    margin-top: 70px
}

.mb-70 {
    margin-bottom: 70px
}

.card {
    box-shadow: 0 0.46875rem 2.1875rem rgba(4, 9, 20, 0.03), 0 0.9375rem 1.40625rem rgba(4, 9, 20, 0.03), 0 0.25rem 0.53125rem rgba(4, 9, 20, 0.05), 0 0.125rem 0.1875rem rgba(4, 9, 20, 0.03);
    border-width: 0;
    transition: all .2s
}

.card {
    position: relative;
    display: flex;
    flex-direction: column;
    min-width: 0;
    word-wrap: break-word;
    background-color: #fff;
    background-clip: border-box;
    border: 1px solid rgba(26, 54, 126, 0.125);
    border-radius: .25rem
}

.card-body {
    flex: 1 1 auto;
    padding: 1.25rem
}

.vertical-timeline {
    width: 100%;
    position: relative;
    padding: 1.5rem 0 1rem
}

.vertical-timeline::before {
    content: '';
    position: absolute;
    top: 0;
    left: 26%;
    height: 100%;
    width: 4px;
    background: #e9ecef;
    border-radius: .25rem
}

.vertical-timeline-element {
    position: relative;
    margin: 0 0 1rem
}

.vertical-timeline--animate .vertical-timeline-element-icon.bounce-in {
    visibility: visible;
    animation: cd-bounce-1 .8s
}

.vertical-timeline-element-icon {
    position: absolute;
    top: 0;
    left: 60px
}

.vertical-timeline-element-icon .badge-dot-xl {
    box-shadow: 0 0 0 5px #fff
}

.badge-dot-xl {
    width: 18px;
    height: 18px;
    position: relative
}

.badge:empty {
    display: none
}

.badge-dot-xl::before {
    content: '';
    width: 10px;
    height: 10px;
    border-radius: .25rem;
    position: absolute;
    left: 50%;
    top: 50%;
    margin: -5px 0 0 -5px;
    background: #fff
}

.vertical-timeline-element-content {
    position: relative;
    margin-left: 27%;
    font-size: .8rem
}

.vertical-timeline-element-content .timeline-title {
    font-size: .8rem;
    text-transform: uppercase;
    margin: 0 0 .5rem;
    padding: 2px 0 0;
    font-weight: bold
}

.vertical-timeline-element-content .vertical-timeline-element-date {
    display: block;
    position: absolute;
    left: -25%;
    top: 0;
    /* padding-right: 10px; */
    text-align: right;
    /* color: #adb5bd; */
    font-size: .7619rem;
    white-space: nowrap;

    border-radius: 4px;
    background-color: #007bff;
    display: inline-block;
    font-weight: 600;
    color: white;
    padding: 5px;
}

.vertical-timeline-element-content:after {
    content: "";
    display: table;
    clear: both
}




</style>








<style>



























    
.plus-item{

display: none;

}
.minus-item{

display: none;

}

.table-sm td {
  
    text-align: center;
}



.select2-results__option[aria-selected] {
   
    background: #c1c1c1; 
}

select2-container--default .select2-results__option--highlighted[aria-selected] {
    background-color: #909090;
    color: white;
}

/* .select2-results{

    width: 226%;
    float: right;

} */

.right, .entered_price{

    text-align: right;
}

.total{
    font-weight: bold;
}

#search-tbl_filter > label{

    font-weight: bold;
}



/* table#datagrid td:nth-child(9) {
   display: none;
} */
/* table#datagrid th:nth-child(9) {
   display: none;
} */




/* table#datagrid td:nth-child(15) {
   display: none;
}
table#datagrid th:nth-child(15) {
   display: none;
} */


/* table#datagrid td:nth-child(10) {
   display: none;
}
table#datagrid th:nth-child(10) {
   display: none;
} */

/* table#datagrid td:nth-child(11) {
   display: none;
}
table#datagrid th:nth-child(11) {
   display: none;
} */

/* table#datagrid td:nth-child(12) {
   display: none;
}
table#datagrid th:nth-child(12) {
   display: none;
} */

/* table#datagrid td:nth-child(14) {
   display: none;
}
table#datagrid th:nth-child(14) {
   display: none;
} */

@-webkit-keyframes blink {
    50% {
        color: darkred;
        background: white
    }
}
@-moz-keyframes blink {
    50% {
        color:darkred;
        background: white
    }
}
@keyframes blink {
    50% {
        color: darkred;
        background: white
    }
}
.blink {
    -webkit-animation-direction: normal;
    -webkit-animation-duration: 5s;
    -webkit-animation-iteration-count: infinite;
    -webkit-animation-name: blink;
    -webkit-animation-timing-function: linear;
    -moz-animation-direction: normal;
    -moz-animation-duration: 5s;
    -moz-animation-iteration-count: infinite;
    -moz-animation-name: blink;
    -moz-animation-timing-function: linear;
    animation-direction: normal;
    animation-duration: 5s;
    animation-iteration-count: infinite;
    animation-name: blink;
    animation-timing-function: linear;
}











#show-cart td, .table-sm th {
   
    border: 1px solid #17a2b861;
}

#show-cart > thead > tr > td{

font-weight: bold;

}
#dept_line{
        
        
        }
.badge{
    padding: 4px;

}
   .dt-button {
    padding: .25rem .5rem;
    font-size: .875rem;
    line-height: 1.5;
    border-radius: .2rem;
    color: #fff;
    background-color: #007bff;
    border-color: #007bff;
    box-shadow: none;
    }
#products_wrapper > div:nth-child(2) > div
{
    overflow: hidden;
    overflow-y: scroll !important;
    height: 300px !important;
}
#products > thead
{
    position: sticky;
    top: 0px;
    background: white;
}

#sp_products_wrapper > div:nth-child(2) > div
{
    overflow: hidden;
    overflow-y: scroll !important;
    height: 300px !important;
}
#sp_products > thead
{
    position: sticky;
    top: 0px;
    background: white;
}


#search-tbl > tfoot > tr > th > input[type=text]
{

    width: 100%;

}
.tbl_font
{
    font-size:14px;
}

.row-checkbox
{
    zoom: 1.8;
    margin-top: 2px;
    
}
.dataframe{
  
    width: 100%;

}
/* @-webkit-keyframes argh-my-eyes {
    0%   { background-color: #ffdddd !important; }
    49% { background-color: #e4aaaa !important }
    50% { background-color: rgb(255, 255, 255); }
    99% { background-color: rgb(197, 80, 80); }
    100% { background-color: #fff; }
  } */
  /* @-moz-keyframes argh-my-eyes {
    0%   { background-color: #ffdddd !important; }
    49% { background-color: #e4aaaa !important }
    50% { background-color: rgb(255, 255, 255); }
    99% { background-color: #a29c9c; }
    100% { background-color: #fff; }
  } */
  @keyframes argh-my-eyes {
    0%   { background-color: #ffdddd !important; }
    49% { background-color: #e4aaaa !important }
    50% { background-color: rgb(255, 255, 255); }
    99% { background-color: #a29c9c;  }
    100% { background-color: #fff; }
  }
  .forty_eight
{
  -webkit-animation: argh-my-eyes 1s infinite;
  -moz-animation:    argh-my-eyes 1s infinite;
  animation:         argh-my-eyes 5s infinite;
  /*background-color: #ffdddd !important*/
}
.tw_four
{
    /* background-color: #ca2424 !important */
    color: red;
}
tfoot 
{
    display: table-header-group;
}

</style>

<script>
function los_modal_s(thizz)
{
    $('#los_modal').modal('show');
}

document.addEventListener('DOMContentLoaded', function(event) {
  
    $('#los_modal').on('shown.bs.modal', function (e) {
        //alert("I want this to appear after the modal has opened!");
    })
    initSelect2();

})




function initSelect2()
{
            $('select.xselect2').select2({
                    placeholder:' - Select -',
                    dropdownAutoWidth : true,
                    // tags: true,
                    allowClear: true,
                    // minimumResultsForSearch: Infinity,
                    dropdownParent:$('select.xselect2').closest('div'),
                    minimumInputLength: 0,
                    language: {
                        inputTooShort: $('<div>Please select </div>')
                    },
                    ajax: {
                        url: "{% url 'saleswores:lovs_saleswores' %}",
                        dataType: 'json',
                        delay: 250,
                        beforeSend:function(xhr,settings){
                            if (!this.crossDomain) {
                                xhr.setRequestHeader("X-CSRFToken", "{{csrf_token}}");
                                }
                        },
                        data: function (params) {
                            if ( $('.select2-results').find('.search-loader').length == 0){
                                $('.select2-results').append('<div class="d-flex search-loader justify-content-center p-2">\
                                <div class="spinner-grow text-info" role="status"><span class="sr-only">Loading...</span></div></div>');
                            }
                            console.log(this);
                            return {
                                q: params.term, // search term
                                page: params.page,
                                select_name:this.attr('name'),
                                defs:localStorage.getItem('defs'),
                                customer_id:$('#searchCust').val() == null ? -1: $('#searchCust').val(),

                            };
                    },
                    processResults: function (data, params) {
                            $('.search-loader').remove();
                            params.page = params.page || 1;
        
                            // console.log(this);
        
                            return {
                                results: data.items,
                                pagination: {
                                    more: (params.page * 30) < data.total_count
                                }
                            };
                        },
                        cache: true
                    },
                    // templateSelection: function (data, container) {
                    //     Object.keys(data).forEach(function (key) {
                    //         $(data.element).attr('data-'+key, data[key]);  
                    //     })
                    //     return data.text;
                    // }
        
                });
        }

function insertlos()
{
            ShowDIV()

        var u_full_name=$('#u_full_name').html();
        
        $('#create_los').prop('disabled', true);

        var organization_name=JSON.parse(localStorage.getItem('defs'))['organization_name'];

        try 
        {
            var main_customner_name=$('#searchCust').select2('data')[0]['customer_name'];

            var main_customer_number=$('#searchCust').select2('data')[0]['customer_number'];

            var email_address =$('#searchCust').select2('data')[0]['email_address']

           var additional_mobile_no=  $('#searchCust').select2('data')[0]['additional_mobile_no']

        } 
        catch (error) 
        {
                console.log(error);
                alert('Please select a customer');
                HideDIV()
                return ;
                // expected output: ReferenceError: nonExistentFunction is not defined
                // Note - error messages will vary depending on browser
        }

        var data = $('.wotags').select2('data')
        var los_reason=data[0].text;

        var remarks =$('#remakrs_').val()

        var qty =1
        var cart= JSON.stringify(shoppingCart.listCart());
        
        
        axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
        axios.defaults.xsrfCookieName = "csrftoken";
        axios.defaults.withCredentials = true;
        axios.post('submit-los', 
        {
            staffname: u_full_name,
            organization_name: organization_name,
            main_customner_name:main_customner_name,
            main_customer_number:main_customer_number,
            los_reason:los_reason,
            remarks:remarks,   
            cart:cart  ,
            email_address:email_address,
            additional_mobile_no:additional_mobile_no      
        })
        .then(function (response) 
        {
            console.log(response);
            toastr.success(response.data.message);
            $('#los_modal').modal('hide');
            HideDIV()
            toastr.success(response.id)




        })


            //var data = parseForm('#lossofsale-form');
           // var custphone =  data.filter(x => x.name == 'custphone')[0].value;
            //if (custphone == "" || custphone.trim().length <10)
           // {
            //    return toastr.error("Please enter a valid phone number ");
           // }

           // var data = parseForm('#lossofsale-form')
            // axios.post('submit-los',{
        // staffname: u_full_name,
        // organization_name: organization_name,
        // main_customner_name:main_customner_name,
        // main_customer_number:main_customer_number,
        // los_reason:los_reason,
        // remarks:remarks,
        // qty:qty                
            //     })
            // .then(function (response) 
            // {
            //     if (response.data.flag == 'S')
            //     {
                   // toastr.success(response.data.message);
                   // $('#lossofsale-form [type="reset"]').click();
                   // window.location.href="/lossofsale/losdetails/"+window.location.search;
                // }
                // else if(response.data.flag == 'E')
                // {
                //     //toastr.error(response.data.message);
                // }
            // })
            // .catch(function(error)
            // {
            //     toastr.error(error.response.data);
            // })
       



}

</script>
<div class="modal" tabindex="-1" role="dialog" id="los_modal">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"></h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          
        <div class="row">
            <div class="col-12">
                <div class="form-group">
                    <label class="control-label col-form-label">Reason for Loss of Sale <span style="color: red;">*</span></label>
                    <select class="select wotags form-control form-control-sm text dyn-fld" type="text" style="width:100%" required><option></option> 
                    </select>
                </div>
            </div>



            <div class="col-12">
                <div class="form-group">
                    <label for="remarks" class="control-label col-form-label">Remarks <span style="color: red;">*</span></label>
                    <textarea class="form-control dyn-fld" id="remakrs_" rows="3" placeholder="Remarks"></textarea>
                </div>
            </div>


        </div>


        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" onclick="insertlos()">Submit</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <button type="button" class="btn btn-info" onclick="cancelScan()" id="cancelScan" style="display: none;">Cancel Scan</button>
  <div style="width: 100% height:100%" id="reader">
</div>


<!-- The Modal -->
<div id="v-dash">

    <!-- <div class="modal  fade modal-small in" id="pdi_req_modal" role="dialog">
        <div class="modal-dialog modal-lg" style="    max-width: 86% !important;">
          <div class="modal-content">      
           
            <div class="modal-header">
              <h4 class="modal-title" style="font-weight: 800;">PDI   ( <span id="order_n">  </span>) <input type="hidden" id="order_id"  /></h4>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            
           
            <div class="modal-body" style="    padding-left: 3%;
            padding-right: 3%;
            margin-bottom: 4%;
            margin-top: 1%;">
            <div id="process_type">
                
            </div> 

            <div id="header_v2">
                
            </div>   

    
              <p>* select lines and then click on save button to create a PDI request</p>
            <div class="table-responsive-sm">
                  
                  <table id="pdi_main_tbl" class="table table-sm  table-hover table-responsive" style="white-space: nowrap;">
                    <thead>
                        <tr>
                      
                        <th></th>
                        <th class="text-center" >SR </th>
                        <th  class="text-center">PDI Number</th>
                        <th  class="text-center">Item Name</th>
                        <th  class="text-center">Item Description</th>

                        <th  class="text-center">Mfg Code</th>
                        <th  class="text-center">UOM</th>
                        <th  class="text-center">Qty</th>
                        <th  class="text-center">Color</th>
                        <th  class="text-center">Year</th>
                        <th  class="text-center">Source</th>
                        <th  class="text-center">PDI Location</th>

                        <th  class="text-center">Serial</th>
                        <th  class="text-center">Required Date</th>
                        <th  class="text-center">From Subinventry</th>
                        <th  class="text-center">Job Card</th>


                        <th  class="text-center">To Subinventry</th>
                        <th  class="text-center">Header Status</th>
                        <th  class="text-center">Line Status</th>
                        <th  class="text-center">PDI Value</th>
                        <th  class="text-center">Delivery Number</th>
                        <th  class="text-center">Workshop Delivery</th> 
                        <th  class="text-center">Return Reason</th>    
                        <th  class="text-center">PDI Activities</th>                                 
                      </tr>
                    </thead>
                    <tbody>
                         
                      <tr v-for="(row,index)  in ret_line_data">    
                          <td    ><input    v-if="row['doc_number']==''"    type="checkbox" /></td>                    
                        <td>[[row.line_number]]</td>
                        <td>[[row.doc_number]]   </td>
                       
                      

                        <td>[[row.item_code]] <br>  <input type="hidden"  v-bind:value="row.order_header"    id="custom_table_oder_number" /></td>
                        <td>[[row.item_code]] <br>  <input type="hidden"  v-bind:value="row.order_header"    id="custom_table_oder_number" /></td>
                      
                            <td>[[row.mfg_code]]</td>
                            <td>[[row.primary_uom_code]]</td>
                            <td >[[row.ordered_qty]]</td>  
                            <td >[[row.color]]</td>  
                            <td >[[row.year]]</td>  
                            <td >[[row.stock_location]]</td> 

                            <td>                              

                                <select    v-if="row['doc_number']==''"        class="form-control" :required="true"  style="    width: 234px;">
                                    <option  v-for="option in ret_line_reason_lov"   v-bind:value="option.lookup_code" > [[option.meaning ]]</option>
                                </select>

                               <span   v-if="row['doc_number']!=''" >[[row.pdi_loc]]</span>

                            </td>
                            <td >[[row.vin_number]]</td>
                            <td><input  v-if="row['doc_number']==''"        v-bind:id="row.line_number"  v-bind:value="row.delivery_date"   type="txt"  />
                                <input  v-if="row['doc_number']!=''" disabled   v-bind:value="row.delivery_date"   type="txt"  />
                            
                            </td>

                            <td>  [[row.subinventory]]</td>
                            <td></td>
                            <td>  [[row.subinventory]]</td>
                            <td> [[row.header_status]]</td>
                            <td> [[row.line_status]]</td>                           
                            <td></td>
                            <td></td>
                            <td></td>
                           
                            
                           
                        <td>
                            <input type="hidden"  v-bind:value="row.order_header_id"    id="custom_table_oder_header_id" /> 
                            <span style=" color: #E13300"  v-bind:id="[[index+1+'msg']]" ></span>
                        </td>                    
                        <td>
                                <button  v-if="row['doc_number']!=''"     v-bind:id="row.line_id" style="    line-height: 12px;"      class="btn btn-sm btn-primary" onclick="line_activity(this)">Add Line Activities</button>                            
                               
                               <span   v-if="row['doc_number']!=''">

                                <button   v-if="row['line_status']=='Draft'"     v-bind:id="row.header_id"  style="    line-height: 12px;"     onclick="request_pdi(this)"   class="btn  btn-sm btn-primary">Submit Request </button>
                       

                               </span>
                              
                       
                            </td>                        
    
                      </tr>
                    </tbody>
                  </table>
            </div>
    
            </div>
            
            
            <div class="modal-footer">
              <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
              <button type="button" class="btn bg-olive btn-flat"  id="sbtn_pdi" onclick="create_pdi_req_header()" >Save</button>
    
    
            </div>
            
          </div>
        
        
        
        </div>
      
    
    
    
    
    </div> -->

    <div class="modal  fade modal-small in" id="pdi_req_line_modal" role="dialog">
        <div class="modal-dialog modal-lg" style="    max-width: 50% !important;">
          <div class="modal-content">      
            <!-- Modal Header -->
            <div class="modal-header">
              <h4 class="modal-title" style="font-weight: 800;"></h4>
              <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <!-- Modal body -->
            <div class="modal-body"  id="pdi_req_line_modal_body" style=" padding-left: 3%;      padding-right: 3%; margin-bottom: 4%; margin-top: 1%;">                  
            </div>
            
            <!-- Modal footer -->
           
          </div>
        
        
        </div>
      
    
    
    
    
    </div>



<div class="modal  fade modal-small in" id="ret_modal" role="dialog">
    <div class="modal-dialog modal-lg" style="    max-width: 65% !important;">
      <div class="modal-content">      
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title" style="font-weight: 800;">Return Sales</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        
        <!-- Modal body -->
        <div class="modal-body">
            <div class="row">
            <div class="col-sm-2">
            <label>

                Return Type :

            </label>

            </div>
            <div class="col-sm-5 text-left">
                <select class="form-control" :required="true" id="sales_type_list" onchange="get_ret_line_type(this)">
                    <option  v-for="option in ret_type"    v-bind:value="option.id" >[[option.text ]]</option>
                  </select>

            </div>
            </div>

            <br>

          
            <div class="table-responsive-sm">
              
              <table id="firstTable" class="table table-sm  table-hover table-responsive" style="white-space: nowrap;">
                <thead>
                    <tr>
                    <!-- <th v-for="row in ret_line_col"> [[row.title]]</th> -->
                    <th class="text-center" >SR </th>
                    <th  class="text-center">Item Name</th>
                    <th  class="text-center">Qty</th>
                    <th  class="text-center" style="width: 4%;">Returned</th>
                    <th  class="text-center" style="width: 4%;">Return Qty</th>
                    <th  class="text-center">Return Category</th>        
                    <th  class="text-center">Return Reason</th>    
                    <th  class="text-center"  style="display: none;">Line Type</th>                                 
                  </tr>
                </thead>
                <tbody>
                  <tr v-for="(row,index)  in ret_line_data">
                    <td>[[row.line_number]]</td>
                    <td  style="text-align: center; padding-top: 12px;" >[[row.item_code]] <br>  <input type="hidden"  v-bind:value="row.order_header"    id="custom_table_oder_number" />
                        <input type="hidden"  v-bind:value="row.order_header_id"    id="custom_table_oder_header_id" /> 
                        <span style=" color: #E13300"     v-bind:id="[[index+1+'msg']]" ></span></td>
                    <td  style="text-align: center; padding-top: 12px;"  >[[row.ordered_qty]]</td>     
                    <td style="text-align: center; padding-top: 12px;">[[row.returned]]</td>    
                    <td ><input      type="text" class="form-control"  placeholder="0" v-bind:id="[[index+1]]"  v-bind:data_val="[[row.ordered_qty- row.returned]]"   name="qty[]"  value="0" onkeyup="receivedPurchase(this)"  /></td>  
                    <td>
                        <select class="form-control" :required="true" >
                            <option  v-for="option in ret_line_reason_lov"   v-bind:value="option.lookup_code" > [[option.meaning ]]</option>
                          </select>
                    </td>
                    <td><textarea style="    width: 100%;line-height: 31px;"  rows="1" placeholder="Return remarks " ></textarea><input type="hidden"  v-bind:value="row.inventory_item_id"  />                     
                        
                    </td>
                    <td  style="display: none;"> 

                            <select   v-bind:id="[[index+1+'ret_line_type']]"  >
                                <option  v-for="option in ret_line_type"    v-bind:value="option.value" > [[option.display ]]</option>
                            </select>

                    </td>

                  </tr>
                </tbody>
              </table>
            </div>

        </div>
        
        <!-- Modal footer -->
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
          <button type="button" class="btn bg-olive btn-flat"  id="sbtn_r" onclick="savereturn()" >Save</button>


        </div>
        
      </div>
    
    
    
    </div>
  




</div>


  <!-- The Modal -->






<div class="modal  fade modal-small in" id="ret_rec" role="dialog">
    <div class="modal-dialog modal-lg" style="    max-width: 65% !important;">
      <div class="modal-content">      
        <!-- Modal Header -->
        <div class="modal-header">
          <h4 class="modal-title" style="font-weight: 800;">Return Receiving</h4>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        
        <!-- Modal body -->
        <div class="modal-body" id="ret_rec_body">
        

        </div>  
        <div class="modal-footer">
          <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
          <button type="button" class="btn bg-olive btn-flat"  onclick="ret_receving_btn()" >Confirm Receiving</button>
        </div>        
      </div> 
    
    
    </div>
</div>



</div>
<div class="modal" tabindex="-1" role="dialog" id="approver_history">
    <div class="modal-dialog" role="document" style="    max-width: 100%;">
      <div class="modal-content">
        <div class="modal-header">        
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body"  id="time_lines_list">       

            <!-- <div class="row d-flex justify-content-center">
                <div class="col-md-12">
                    <div class="main-card mb-3 card">
                        <div class="card-body">              
                            <div class="vertical-timeline vertical-timeline--animate vertical-timeline--one-column" id="time_lines_list">
                              

                            </div>
                        </div>
                    </div>
                </div>
            </div> -->
         
         

        </div>        
        <div class="modal-footer">
                 <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>

      </div>
    </div>
  </div>








<div class="modal" tabindex="-1" role="dialog" id="initiate_payment_modal"  data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog" role="document" style="    max-width: 100%;margin-left: 1%;">
      <div class="modal-content">
        <div class="modal-header">

          <h4 class="modal-title">Initiate Advance Payment</h4>

          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">

         <div class="table-sm" id="initiate_payment_modal_data">
           
            

         </div>

         
         

        </div>
        
        <!-- <div class="modal-footer"    id="initiate_payment_modal_data_footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
         
        </div> -->
      </div>
    </div>
  </div>



  <div class="modal" tabindex="-1" role="dialog" id="reservation_detail"   tabindex="-1" role="dialog" aria-labelledby="staticBackdropLabel" aria-hidden="true">
    <div class="modal-dialog" role="document" style="    max-width: 100%;margin-left: 1%;">
      <div class="modal-content">
        <div class="modal-header">

          <h4 class="modal-title">Reservation Details</h4>

          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">


            <div id="rdtl"></div>
         

        </div>
        

      </div>
    </div>
  </div>









  


  <div class="modal" tabindex="-1" role="dialog" id="reservation_modal">
    <div class="modal-dialog" role="document" style="    max-width: 65%;">
      <div class="modal-content">
        <div class="modal-header">

          <h4 class="modal-title">Extend Reservation <span id="res_number"></span></h4>

          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">
        <div class="row">

            <div class="col-sm-2">
                <label> Remarks :</label> 
           </div>

           <div class="col-sm-6">
                        <textarea   style="    width: 100%;" placeholder="Please write here"   id="remarks"></textarea>
           </div>
        </div><br>
           <div class="row">

            <div class="col-sm-2">

                <label>Days :</label> 

            </div>
            <div class="col-sm-6">
                  <input  style="width:100%;"  type="text" id="days" value="7" />

            </div>
        </div>




         
         

        </div>
        
        <!-- <div class="modal-footer"    id="initiate_payment_modal_data_footer">
          <button type="button" class="btn btn-secondary" onclick="extend_reser()"  >Update</button>
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
         
        </div> -->
      </div>
    </div>
  </div>


  <div class="modal" tabindex="-1" role="dialog" id="related_item_modal"  >
    <div class="modal-dialog" role="document" style="    max-width: 100%;margin-left: 1%;">
      <div class="modal-content">
        <div class="modal-header">

          <h4 class="modal-title">Related Items</h4>

          <button type="button" class="close related_modal_close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>

        <div class="modal-body">

         <div >
            <table class="table no-wrap table table-sm table-bordered text-center"  id="related_item_tbl">
                <thead>
                    <tr>
                        <th>Action </th>
                        <th> Item Code </th>
                        <th> Avl Qty </th>
                        <th> Description</th>
                        <th> UOM  </th>
                        <th> Unit Selling Price  </th>
                    </tr>
                </thead>
              
                <tbody>
                </tbody>
            </table>
         </div>

        </div>
      </div>
    </div>
  </div>




<style>
	.autocomplete {
  /*the container must be positioned relative:*/
  position: relative;
  display: inline-block;
}
	.autocomplete-items {
  position: absolute;
  border: 1px solid #d4d4d4;
  border-bottom: none;
  border-top: none;
  z-index: 99;
  /*position the autocomplete items to be the same width as the container:*/
  top: 100%;
  left: 0;
  right: 0;
}
.autocomplete-items div {
  padding: 10px;
  cursor: pointer;
  background-color: #fff;
  border-bottom: 1px solid #d4d4d4;
}
.autocomplete-items div:hover {
  /*when hovering an item:*/
  background-color: #e9e9e9;
}
.autocomplete-active {
  /*when navigating through the items using the arrow keys:*/
  background-color: DodgerBlue !important;
  color: #ffffff;
}

.initSelc2  + .select2-container--default .select2-selection--single .select2-selection__rendered {
    color: #444;
    line-height: 36px;
}

.initSelc2  + .select2-container .select2-selection--single 
{
    box-sizing: border-box;
    cursor: pointer;
    display: block;
    height: 50px;
    user-select: none;
    -webkit-user-select: none;
}

.select2-container .select2-selection--single {
   
    height: 100% ; 
    padding: 6px;
    
}
</style>

<!-- //////////////////////sher/////////////////// -->
<!-- <div class="row" id="counts_row" hidden style="margin: unset !important;"> 
    <div class="col-12 col-sm-6 col-md-3">
      <div class="info-box" onclick="onDashClick(this)" style="background-color:#a0a0a0">
        <span class="info-box-icon bg-info elevation-1"><i class="ion ion-cube"></i></span>

        <div class="info-box-content">
          <span class="info-box-text">Create Sales Order</span>
          <span class="info-box-number">
            
            <small></small>
          </span>
        </div>
      </div>
    </div>
    
    <div class="col-12 col-sm-6 col-md-3">
      <div class="info-box mb-3" onclick="onDashClick(this)">
        <span class="info-box-icon bg-danger elevation-1"><i class="ion ion-refresh"></i></span>

        <div class="info-box-content">

          <span class="info-box-text">In Process Orders</span>
          <span class="info-box-number">[[data.reserved_stock]]</span>
        </div>
        
      </div>
    </div>
    


    <div class="clearfix hidden-md-up"></div>

    <div class="col-12 col-sm-6 col-md-2">
      <div class="info-box mb-3" onclick="onDashClick(this)">
        <span class="info-box-icon bg-success elevation-1"><i class="ion ion-android-archive"></i></span>

        <div class="info-box-content">
          <span class="info-box-text">Approved Orders</span>
          <span class="info-box-number">[[data.on_order]]</span>
        </div>
        
      </div>
    </div>



    <div class="col-12 col-sm-6 col-md-2" >
        <div class="info-box mb-3" onclick="onDashClick(this)">
          <span class="info-box-icon bg-warning elevation-1"><i class="ion ion-filing"></i></span>
  
          <div class="info-box-content">
            <span class="info-box-text">Closed Orders</span>
            <span class="info-box-number">[[data.closed_orders]]</span>
          </div>
          
        </div>

      </div>


    
    <div class="col-12 col-sm-6 col-md-2">
      <div class="info-box mb-3" onclick="onDashClick(this)">
        <span class="info-box-icon bg-warning elevation-1"><i class="ion ion-filing"></i></span>

        <div class="info-box-content">
          <span class="info-box-text">Return Orders</span>
          <span class="info-box-number">[[data.all_on_order]]</span>
        </div>
        
      </div>

    </div>

    <div class="col-12 col-sm-6 col-md-2" style="display: none;">
        <div class="info-box mb-3" onclick="onDashClick(this)">
          <span class="info-box-icon bg-warning elevation-1"><i class="ion ion-filing"></i></span>
  
          <div class="info-box-content">
            <span class="info-box-text">PDI Requests</span>
            <span class="info-box-number">[[data.pdi_req]]</span>
          </div>
          
        </div>

      </div>


    
  </div> -->


<div class="row content-body" style="margin: unset;display: none;" >
          <div class="col-lg-12 col-lg-6">
            <div class="card card-primary card-outline card-outline-tabs">
              <div class="card-header p-0 border-bottom-0">
                <ul class="nav nav-tabs" id="custom-tabs-four-tab" role="tablist">
                  <li class="nav-item">
                    <a class="nav-link active" onclick="onPreview(false);" id="custom-tabs-four-home-tab" data-toggle="pill" href="#custom-tabs-four-home" role="tab" aria-controls="custom-tabs-four-home" aria-selected="true">Create Order</a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="custom-tabs-four-profile-tab" onclick="onPreview(true); previewOrderDetail();" data-toggle="pill" href="#custom-tabs-four-profile" role="tab" aria-controls="custom-tabs-four-profile" aria-selected="false">Preview</a>
                  </li>
                  <li class="ml-auto mt-auto mb-auto mr-2 nav-item">
                    Order Status: <span id="order-status" class="font-weight-bold">Draft</span>
                  </li>
                </ul>
              </div>
              <div class="card-body p-0">
                <div class="tab-content" id="custom-tabs-four-tabContent">
                  <div class="tab-pane fade show active d-none"  id="custom-tabs-four-home" role="tabpanel" aria-labelledby="custom-tabs-four-home-tab">
            
                  </div>
                  <div class="tab-pane fade d-none" id="custom-tabs-four-profile" role="tabpanel" aria-labelledby="custom-tabs-four-profile-tab">
                     <div class="card-body">
      


            <div class="row"  id="cart_area">
            
                <div class="col-sm-12" id="stock_view" style="text-align: left;">
                       <div class="card">
                           <div class="card-header bg-info" style="display: none;">
                               <h5 class="m-b-0 text-white">Cart
                                   <i style="color: white;    float: right;" id="full_screen"   onclick="fullscreen(this.id)"  class="fa fa-plus fa-1x "  aria-hidden="true"></i>
                               </h5>
                              
                           </div>
                           <div >
                               
                       <!--<a  class="btn btn-default btn-sm  waves-effect waves-light" data-toggle="collapse" href="#collapseExample" id="cart_number" role="button" aria-expanded="false" aria-controls="collapseExample">
                               <i class="mdi mdi-cart"></i>    Cart
                       -->
            
                       <a type="button" style="display: none;"   id="btn_cart" data-toggle="collapse" href="#collapseExample" aria-controls="collapseExample" class="btn btn-sm waves-effect waves-light cart-btn btn-primary collapsed" aria-expanded="false"><i class="mdi mdi-cart"></i>Cart (<span class="total-count">0</span>)</a>
                              
                       <a type="button" style="display: none;"  id="btn_cart_1"  href="{% url 'checkout_page' %}"  class="btn btn-sm waves-effect waves-light cart-btn btn-primary " aria-expanded="false">
                               <i class=" mdi-open-in-new mdi mdi-cart"></i> checkout
                       </a>
                     
            
            
              <!-- <div class="collapse" id="collapseExample">
               <div class="card ">
                      <table class="table table-sm  no-wrap table table-sm table-bordered text-center show-cart" id="show-cart">
            
                       </table>
                                                  
            
               </div>
               <button id="clear-cart" class="btn btn-default btn-sm">Clear Cart</button>
               </div> -->
               
               <ul class="nav nav-tabs" id="myTab" role="tablist">
                   <li class="nav-item"    style="display: none;">
                     <a class="nav-link" id="home-tab" data-toggle="tab" href="#home" role="tab" aria-controls="home" aria-selected="flase">Units Stock</a>
                   </li>
                   <li class="nav-item" style="    display: none;">
                     <a class="nav-link active" id="profile-tab" data-toggle="tab" href="#profile" role="tab" aria-controls="profile" aria-selected="true" onclick="get_order_type_lov()">Shopping Cart</a>
                   </li>
                   <!-- <li class="nav-item">
                     <a class="nav-link" id="contact-tab" data-toggle="tab" href="#contact" role="tab" aria-controls="contact" aria-selected="false">Accessories Stock</a>
                   </li> -->
                 </ul>
            
                 <div class="tab-content" id="myTabContent">
                   <div class="tab-pane fade show active" id="home" role="tabpanel" style="display: none;" aria-labelledby="home-tab">
            
                           <div class="row">
                               <!-- column -->
                               <div class=" col-md-12">
                                   <div class="card">
                                       
                                       
                                       <div class="table-responsive" style="margin-top: 11px;">
            <!-- 
                                           <button  type="button" class="add-to-cart pull-right btn btn-sm btn-info" onclick="" >Add To Cart <i style="color: white;" class="fa fa-cart-plus fa-1x "  aria-hidden="true"></i></button> 
            
                                           <table  class="table w-100 table-sm table-responsive table-bordered table-striped no-wrap"     id="products"></table>
            -->
                                       </div>
                                   </div>
                               </div>
                               
                           </div>
            
            
            
            
                   </div>
            
            
                   <div class="tab-pane fade show active" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                           <!--tydeaitls here-->
            
                           
                           <div class="card">  
                              
                            <!-- <div class="card-body" id="invoice_total_v">   -->
                          
                            </div> 
                   </div>
                 </div>
                           </div>
                       </div>
            
               </div>
              
     
        
        
        
            </div>
            

            
        </div>
                  </div>
                </div>



                <div class=" common_area_cls" id="avlable_stock">

                    <input type="hidden"  id="cust_disc_perc" value=0 />
                    <input type="hidden"   id="discount_id" value=0 />


                    <input type="hidden"  id="actual_bal_amount" value=0 />
                    <input type="hidden"  id="customer_limit" value=0 />
<div class="accordion" id="accordionExample">
<div class=" m-0">
<div class="card-header d-none" id="headingTwo_1" style="padding: 0px">
    <h2 class="mb-0">
        <div class="row">
            <div class="col-lg-3 col-md-3 col-xl-3 d-none">
               <button type="button" class="btn btn-link collapsed" data-toggle="collapse" data-target="">Fill Customer Details</button>  
            </div>
            <div class="col-lg-6 col-md-6 col-xl-6">
                <div class="card-body" style="padding: 0px" hidden>
                    <div class="form-group row col-lg-12" >
                        <label  class="col-sm-3 text-right col-form-label" style="font-size: 16px;">Search By :</label>
                        
                        <div class="col-sm-4" style="margin-top: 7px;">
                            <select name="" class="form-control-plaintext"  id="serach_based_on_type" style="width: 100% ; ">       
                                <option value=""></option>                   
                            </select>
                        <!-- <input type="text" readonly class="form-control-plaintext" id="staticEmail" value="email@example.com"> -->
                        </div>
                    </div>
                </div>  
            </div>
            <div class="col-lg-3 col-md-3 col-xl-3">
            <span id="sel_cust" style="float: right;font-size: 16px;color: green;padding-top: 12px;"></span>  
            </div>
        </div>
    </h2>
</div>
<!-- multi-collapse -->
<div id="" class="d-none" aria-labelledby="headingTwo_1" > 
    <div class="card-body" style="padding: 0px">
        <div class="row"  id="cart_area">
            <div class="col-sm-6 col-md-6  col-xl-6  p-0">
                <div class="card m-0">
                    <div class="card-header">
                        <h3 class="card-title">Bill To Customer</h3>
                        <div class="card-tools"style="margin-top: -10px;">      
                            <a target_='blank' id="new_customer_url" href='#' target='_blank' style="float: right; margin: 0px;">New Customer : <i class="fa fa-plus-square" aria-hidden="true" style="float: right;margin-top: 2px; margin-left: 6px;font-size: 19px;"></i></a> 
                        </div>
                    </div>  
                    <div class="card-body" style="padding-top: 5px; padding-bottom: 0px;">
                        <div class="row">
                            
                        </div>
                    </div>
                    <div class="card-footer d-none">
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-md-6  col-xl-6  p-0">
                <div class="card m-0">
                    <div class="card-header">
                      <h3 class="card-title">                      
                        Ship To Customer                      
                      </h3>
                      <div class="card-tools">
                      </div>
                    </div>  
                    <div class="card-body" style="padding-top: 5px; padding-bottom: 0px;">
                        <div class="row">
                            
                        </div>
                    </div>
                    <div class="card-footer d-none">
                    </div>
                </div>
            </div>


<!--  //////////////////////////////////Sher////////////////////////////////  -->
                   <div class="col-sm-6 col-md-6  col-xl-6 " hidden>



                    <div class="card">

                        <div class="card-header">
                          <h3 class="card-title">                      
                            Bill To Customer                      
                          </h3>
                          <div class="card-tools">      
                          
                            <!-- <span class="badge badge-primary">
                             
                            <!-- <a target_='blank' id="new_customer_url" href='#' target='_blank' style="float: right;">New Customer : <i class="fa fa-plus-square" aria-hidden="true" style="float: right;margin-top: 2px; margin-left: 6px;font-size: 19px;"></i></a> 
                             -->
                            <!-- </span> -->
                            
                          </div>
                        </div>  
                      
                        <div class="card-body">
    
                            <div class="row">
                                <div class="col-sm-12">


                                    <div class="form-group">                                              
                                        <select name=""   id="customer_bill" class="form-control-sm"  style="width: 100% ; "></select>
                                    
                                    </div>
                                    

                                    <div id="bill_to_customer_infoo">

                                        
                                    </div>

                        
                             
        
<!--                                        
                      
                               <form>
                                   <fieldset>
                                       <h3 style="max-width: 30%;">Bill To:</h3>
        
        
                                       <table style="width:100%" id="ship_to_tbl">
                                           <tr  style="display: none;">
                                               <th>
                                                   Location</th>
        
                                          <td>
                                               
                                               <input type="text" class="form-control  form-control-sm " id="location_bill"  placeholder="" readonly>
                                       
                                           </td>
                                           </tr>
        
                                           <tr><th>Customer</th>
                                               <td>
                                              
                                               <select name="" class="form-control  form-control-sm "  id="customer_bill" style="width: 100% ; "></select>
                                           </td>    
                                           </tr>
        
                                       
                                       <tr>
                                           <th>Number</th>
                                       
                                           <td>
                                                 <select disabled  class="form-control  form-control-sm " id="number_bill"  style="width: 100% ; "></select>
                                           </td>
                                       
                                       </tr>
        
                                           <tr>
                                               <th>Address</th>
                                               <td>
                                                   <input type="text" class="form-control  form-control-sm " id="address_bill"  placeholder="" readonly>
                                               </td>
                                           </tr>
        
                                       <div class="m-1 row " style="display:none;">
                                               <label for="address_2"
                                                   class="col-sm-3 col-form-label"></label>
                                               <div class="col-sm-8">
                                                   <input type="text" class="form-control  form-control-sm " id="address_2_bill"  placeholder="" readonly>
                                               </div>
                                       </div>
        
                                       <div class="m-1 row" style="display:none;">
                                               <label for="address_3"
                                                   class="col-sm-3 col-form-label"></label>
                                               <div class="col-sm-8">
                                                   <input type="text" class="form-control  form-control-sm " id="address_3_bill"  placeholder="" readonly>
                                               </div>
                                       </div>
                                       <tr><th> </th><td>
                                                   <input type="text" class="form-control  form-control-sm " id="area_bill"  placeholder="" readonly>
                                       </td></tr>
        
                                       <tr><th> </th><td>
                                                   <input type="text" class="form-control  form-control-sm " id="country_bill"  placeholder="" readonly>
                                       </td></tr>
        
                                       <tr>
                                           <th> Contact 
        
                                           </th>                                            
                                           <td> 
                                                <input type="text" class="form-control  form-control-sm " id="contact_bill"  placeholder="" readonly>
                                          
                                           </td>
                                         
                                       </tr>
                                       </table>
        
        
        
                                   </fieldset>
                               </form>
         -->
        
                               
                           </div>
                       </div>
                   </div>

                   <div class="card-footer d-none">
              
                </div>
                 
              
                </div>
               
            
            </div>
        
        
        
        
      </div>          
        
               <!-- </div>
               
           </div>
        </div> -->
        

        
    </div>
</div>


<div id="invoice_total_v"  class=" p-3 m-0" style="zoom:.85">  
    <div id="data"></div>
    <form action='#'> 
        {% csrf_token %} 
        <div class="form-row">  
            
            <div class="{% if can_apply_quotation %}col-md-4{% else %}col-md-6{% endif %}">
                <label>Bill To Customer: <span style="color: red;"> *</span></label>  

                <div class="form-group">
                    <select name="" id="searchCust"  class="form-control-sm" style="width: 100% ; ">
                        <option></option>
                    </select>
                    <input type="hidden" id="main_cust" />
                    <input type="hidden" id="main_customer_number" />
                    <input type="hidden" id="main_customer_id" />
                </div>
                <div id="customer_infoo" class="row" style="zoom: 0.9;">
                </div>                                 
            </div>
            
            <div class="{% if can_apply_quotation %}col-md-2{% else %}d-none{% endif %}" id="quotationSelection">  
                <label>Apply Quotation :</label>              
                <select name="cust_quotations" class="xselect2 form-control-sm" id="cust_quotations"></select>  
 
            </div> 
            <div class="col-md-6 d-none">
                <label>Ship To Customer: <span style="color: red;"> *</span></label>  
                <div class="form-group">                                              
                    <select name=""  class="col-sm-4 form-control-sm" data-special-id="customer-search"  id="customer" style="width: 100% ; "></select>
                </div>
                <div id="ship_to_customer_infoo" class="row" style="zoom: 0.9;">
                </div>
            </div>

            
            <div class="col-md-3">                                            
                <label>Case Mark :</label>  
                <textarea   type="text" class="form-control form-control-sm" id="case_mark" style="height: 116px;"></textarea>
            </div> 

            
            <div class="col-md-12 d-none">  
                <label>Leads :</label>  
                
                <select class="form-control form-control-sm" required="true" id="leads_lov">
                    <option  v-for="option in leads"    v-bind:value="option.flex_value_id" >[[option.flex_value ]]</option>
                </select>

            </div>

            <div class="col-md-3 d-none">  
                <label>Order Category: <span style="color: red;"> *</span></label>                                                  
                <select class="form-control form-control-sm" required="true" id="order_category_lov">
                    <option  v-for="option in order_category"    v-bind:value="option.flex_value" >[[option.flex_value ]]</option>
                </select>
            </div>





            <div class="col-md-3 d-none">  
                <label>Ship To Customer:</label>  

                <input type="text"  readonly  id="shiptocust"  class="form-control form-control-sm" />  
        

            </div> 

            <div class="col-md-3 d-none">  
                <label>Bill To Customer: </label>  

                <input type="text"  readonly  id="billtocust"  class="form-control form-control-sm" />  
        
            </div> 
            
            

            <div class="col-md-3">                                            
                <label>Packing Instruction :</label>  
                <textarea   type="text" class="form-control form-control-sm" id="p_instructions" style="height: 116px;"></textarea>
            </div>  



            <div class="col-md-3  d-none">  
                <label>Air Miles :</label>  
                <input  type="text" class="form-control form-control-sm" id="txt_air_miles"></textarea>
            </div>
            <div class="col-md-3  d-none">  
                <label>Tax (<span id="vat_percent">[[vat_p]]</span>%) :</label>  
                <input  readonly   id="tax" :value="Number(tv).toFixedRound(2)"   type="text" class="form-control form-control-sm" />  
            </div>

            <div class="col-md-3  d-none">  
                <label>Sub Total :</label>  
                <input type="text"  readonly  id="subtotal" :value="Number(t).toFixedRound(2)" class="form-control form-control-sm" />  
            </div>
            
            
            <div class="col-md-4 d-none">                                            
                <label>Order Note :</label>  
                <textarea   type="text" class="form-control form-control-sm" id="order_remarks"></textarea>
                <button type='button' class='btn btn-danger d-none' id='order-header-error' data-toggle='popover' title='Header Error' data-content=''><i class='right fas fa-info'></i></button>
            </div>  
            


            <div class="col-md-3  d-none">  
                <label>Discount  :</label>  
                <!-- <label>Discount / Surcharge :</label>   -->
                <input readonly type="text" id=""  :value="Number(td).toFixedRound(2)"  placeholder="Enter Mobile Number" class="form-control form-control-sm" />  
            </div> 
            <div class="col-md-3">  
                <label>Order Type: <span style="color: red;"> *</span></label>  
                <select style="width: 100%;"  class="select2-input form-control-sm form-control"    id="order_type_lov_item_page" onchange="order_header_change(this)">                            
                </select>  
                
            </div> 
            
            <div class="col-md-2">  
                <label>Customer LPO:</label>  
                <input type="text" id="customer_po"  class="form-control form-control-sm" /> 
                
            </div> 
            <div class="col-md-1"> 
                <label>Cust Disc  <span class="text-danger" id="cust_discount_label"></span> % :</label>  
                <input  type="text" class="text-right form-control form-control-sm" id="cust_discount"  onkeyup="onCustDiscChange(this)"/>
            </div>  

            
            <div class="col-md-6 border border-info"> 
                <label for="">System Remarks</label>
                <div class="row">
                    <div id="error_area" style="height: 150%;"  >
        
        
                    </div>
                    <div class="col-12" id="system_err"> 
                        
                    </div>
                    
                    <!-- <div class="col-md-2"> 
                    
                    </div> -->
                </div>
                
            </div>
            <div class="col-md-3  d-none">  
                <label>Grand Total :</label>  
                <input readonly  type="text"  :value="Number(gt).toFixedRound(2)" id="g_total"  placeholder="" class="form-control form-control-sm" />  
            </div> 
             
            <div class="col-md-12" style="display: none;">  
                <label> Line Charges :</label>              
                <input readonly  type="text"  id='line_charges'   :value="Number(total_line_charges).toFixedRound(2)"    abc     placeholder="00.0" class="form-control form-control-sm" />  

        


            </div> 
            
        </div>  
    
    </form>  
</div>  
</div>

</div>
            </div>



                <div id="entry-new" class="d-none">
                    <!-- <h2 class="mb-0 card d-flex" v-if="!showPreview">
                        <button type="button" class="btn btn-link text-left">Search Stock</button>
                    </h2> -->
                    
                    <div class="card m-0 table-responsive p-3" style="" >
                        
                                      
    
                    <div class="table-success d-none">NEW</div>
                    <div class="row">
                        <div class="col-sm-2">
                          <b>Total Count :</b> 
                          <span id="total_records">[[lines_data.length - 1]]</span>  
                        </div>
                        <div class="col-sm-2">
                            <table v-if="lines_data.filter(x=>x.inventory_item_enabled_flag == 'E').length" style="white-space: nowrap;" class="table table-sm table-bordered">  <tbody><tr class="table-danger"> 
                                <td>Highlighted items are not available in system.</td></tr></tbody> 
                            </table>
                        </div>
                        <div class="col-sm-8 right">
                            <textarea name ="excel_data" cols="500" id="excel_data" hidden></textarea> 
                            <textarea name ="excel_data" id="new_excel_data" hidden></textarea> 
                            <input type="text" name="" id="customer_vat" hidden> 
                            <input type="tet" name="" id="customer_id" hidden>
                            <input type="text" name="" id="page_info" value="saleswores" hidden>
                            <button type="button" class="btn btn-info not-on-preview-ui mr-1 discount-btn" style="display:none" @click="applyListPrice()">Apply List Price</button>
                            <button type="button" class="btn btn-info not-on-preview-ui mr-1 discount-btn" style="display:none" @click="applyDiscount()">Apply Discount</button>
                            <button type="button" class="btn btn-info not-on-preview-ui" @click="getStockForItems()">Get Stock</button>
                            <button type="button" class="btn btn-danger not-on-preview-ui" @click="removeNotFound()">Remove Not Found</button>
                            <button type="button" class="btn btn-info" onclick="inventorytransfer()" hidden>Inventory Transfer</button>  
                        </div>
                    </div>
    
                    <table class="table table-sm table-bordered text-sm mt-2 mb-0" style="white-space:nowrap;" id="items-entry-tbl">
                        <tfoot>
                            <tr>
                                <td v-for="col in columns" v-if="col.visible" :data-column="col.data"  :class="col.col_class+' font-weight-bold'" v-html="col.hasAggregation ? applyAggregate(col):''"></td>
                                <td  ></td>
                            </tr>
                        </tfoot>
                        <thead>
                          <tr>
                            <th v-for="col in columns" v-if="col.visible" :data-column="col.data" class="text-center" v-html="col.title"></th>
                            <th  class="text-center">Alert</th>
                          </tr>
                        </thead>
                        
                        <tbody>
                            <!-- <tr v-for="(obj,trIndex) in lines_data" v-if="obj.avl_qty == ''">
                                <td  v-for="col in columns">[[ getTDContent(col,obj) ]]</td>
                            </tr> -->
                            <tr v-for="(obj,trIndex) in (showPreview ? getLinesDataForPreview() : lines_data)" :class="obj.inventory_item_enabled_flag == 'E'? 'table-danger' : ''" >
                                
                                <td class="p-0 m-0" v-for="col in columns"  v-if="col.data == 'action' && !showPreview && trIndex != lines_data.length-1">
                                   <button class="btn btn-xs btn-danger"  @click="removeTr(obj,trIndex)"><i class="right fas fa-times"></i></button>
                                   <button class="btn btn-xs btn-info" @click="relatedItems(obj)" v-show="lines_data[trIndex]['related_flag']=='Y'"> Rel Item </button>
                                </td>                           
                                <!-- <td v-else-if="col.data == 'avl_qty' && getTDContent(col,obj) == '' " :class="(obj.item_code != '') ? '' :'table-danger '+col.col_class">
                                    [[ getTDContent(col,obj) ]]
                               </td>
                                <td v-else-if="col.data == 'qty' && obj.avl_qty == '' || obj.avl_qty == '0'"  :class="col.col_class">
                                    [[ getTDContent(col,obj) ]]
                               </td> -->
                                <td v-else-if="col.data == 'no_#' && trIndex != lines_data.length-1">
                                   [[trIndex+1]]
                               </td>
                                <td v-else-if="col.visible"
                                      
                                    @input="editable_fields.includes(col.data) ? lineOnChange(col,obj,$event) :null" 
    
                                    :class="col.col_class + generateTdClass(col,obj,trIndex)" 
                                    :data-column="col.data"

                                    :data-inventory_item_enabled_flag="obj.inventory_item_enabled_flag" 
                                    
                                    style="padding: 3px; margin: 0;    height: 30px;"  
                                    :contenteditable="editable_fields.includes(col.data) && !showPreview && canbeEditable(col,obj,trIndex) " 
                                    :data-ph="col.placeholder"
                                    @paste.prevent="onPasteItemStock(col,obj,$event)"
                                    v-html="getTDContent(col,obj,trIndex) || afterRender()"
                                 ></td>
                                <td  :title="obj.line_error" >
                                    <button  type='button' class="btn btn-outline-danger btn-xs pr-1 pl-1 " v-show="obj.line_error" data-toggle='popover' title='Line Error' :data-content='obj.line_error'><i class='right fas fa-exclamation-triangle'></i></button>
                                </td>
                            </tr>                        
                        </tbody>

                        <tfoot>
                            <tr v-for="(value, key) in column_aggregates_labels">
                                <td :colspan="columns.length-4" class="text-center border-0"></td>

                                <td  colspan="2" class="text-left font-weight-bold">[[  value ]]</td>
                                <td  class="text-right font-weight-bold"> [[ isNaN(column_aggregates[key])? '0.00': addCommas(column_aggregates[key],2)  ]] </td>
                                <td   class="text-center"></td>
                            </tr>
                        </tfoot>
                        
                    </table>
                    
                    </div>  
    
                </div>

                

            
            
            <div class="card">            
                     <div id="show-cart-parent_div" class="d-none" style="overflow: unset;padding: 10px;"> 

                    <table class="table table-sm table-bordered text-sm mt-2 mb-0 text-nowrap show-cart"  id="show-cart" >
            
                    </table>  

                    </div>
                  
                     
            
                </div>
                <div class="row">
        <div class="col-8">
            <h6 hidden>Term & Conditions</h6>
            <textarea hidden id="terms_conditions"  name="terms_conditions" rows="4" cols="50"></textarea>
            <input type="text" name="" id="order_header" hidden>
            <input type="text" name="" id="order_status" hidden>
            <input type="text" name="" id="p_rec_level_id" hidden>
            <input type="text" name="" id="order_type_input" value="Cash" hidden>
        </div>
    </div>
            <button type="button" onclick="get_draft_data(true)" class="ml-2 mt-2 btn btn-info on-preview-ui d-none" id="credit-order-get-bal-btn"> Get Customer Balances</button>

            <div id="customer_receipt" class="card m-0 on-preview-ui" style="display: none;zoom: .75;">
          
            </div>
            <br>

            <div class="document-upload-section d-none m-0 p-3">

                <div id="cust-docs"></div>

                <button type="button" class="ml-2 mt-2 btn btn-info"  data-toggle="modal" data-target="#document_upload_modal"> Upload Emirates ID</button>


                <div class="modal" tabindex="-1" role="dialog" id="document_upload_modal"  data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="staticBackdropLabel" aria-hidden="true">
                    <div class="modal-dialog-centered" role="document" style="    max-width: 100%;margin-left: 1%;">
                    <div class="modal-content">
                        <div class="modal-header">

                            <h4 class="modal-title">Upload</h4>

                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>

                        <div class="modal-body">
                            
                            <div class="form-row">
                                <div class="col-md-4">
                                    <label>EID Front: <span style="color: red;"> *</span></label> 
                                    <div class="form-group">
                                    <input type="file" name="front" id="front" >
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label>EID Back: <span style="color: red;"> *</span></label> 
                                    <div class="form-group">
                                    <input type="file" name="back"  id="back" >
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label>Document Type: <span style="color: red;"> *</span></label> 
                                    <div class="form-group">
                                    <select name="doc_type" id="doc_type"><option value="Emirates ID">Emirates ID</option></select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label>Emirates ID: <span style="color: red;"> *</span></label> 
                                    <div class="form-group">
                                    <input type="text" id="doc_name"  class="doc_name">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label>Expiry Date: </label> 
                                    <div class="form-group">
                                        <input type="text" id="exp_date" class="exp_date">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <button type="button" class="btn btn-success" onclick="uploadDocuments(this)"> Upload Documents</button>
                                </div>
                            </div>
                               
                        

                        </div>
                        
                        <!-- <div class="modal-footer"    id="initiate_payment_modal_data_footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        
                        </div> -->
                    </div>
                    </div>
                </div>




            </div>


            <!-- <button type="button" id="btn_draft_it" onclick="Initialize()" class=" btn-sm btn btn-primary rounded-0" style="    float: right;">Scan Emirates ID</button>
                 
            <textarea class="fontStyle textinput" rows="10" placeholder="Response" style="    width: 100%;     margin-top: 12px;                    margin-bottom: 17px;" id="prgssText" disabled=""></textarea>
    -->


                <div class="on-preview-ui" style="display: none;margin-top:15px;    text-align: right;">  
                    <input type="hidden" id="temp_order_number_to_oracle_order" value="" />
                    <div id="msg_for_edit_order"  style='text-align: left;margin-bottom: 11px;'></div>

                       
                       <button type="button"  id="clear-cart"  class="btn btn-sm btn-danger rounded-0">Clear Cart</button>  
                       <!-- <button type="button"  id="create_los"  onclick="los_modal_s(this)"  class="btn btn-sm btn-danger rounded-0">Create LOS</button>  -->
                       <!-- <button type="button"  id="validate_order" onclick="validate_order(this)"  class="btn btn-primary rounded-0">validate order</button>   -->
                            <input type="hidden" id="order_number" value="{{request.GET.order_number}}">
                            <button type="button" class="btn btn-info pick_slip_options btn-sm" style="display:none" onclick="submit_order(this, false,true)" >Print Pick Slip</button>
                            <button type="button" class="btn btn-info pick_slip_options btn-sm" style="display:none" onclick="submit_order(this, false,false)">View Pick Slip</button>
                       
                       <button type="button"  id="btn_draft_it" onclick="submit_order(this,true)"  class=" btn-sm btn btn-primary rounded-0">Save as Draft</button>  
                       <!-- <button type="button"  id="btn_req_credit" onclick="submit_order(this)"  class="btn btn-sm  btn-primary rounded-0">Req credit limit</button>   -->
                      
                       <button type="button"  id="btn_order" onclick="submit_order(this)"  class="btn btn-primary btn-sm rounded-0">Create Sales Order</button> 
                </div>  

              
              </div>




              <!-- /.card -->
            </div>
          </div>
          
        </div>

    <script>

            // function print_pick_slip(){
            //     order_number = $('#order_number').val()
            // ShowDIV()
            // axios.get("/invoice/pick_slip_print/?order_number="+order_number).then(function(res)
            //             {
            //             HideDIV()
            //             alert('Pick Slip Request # '+res.data.request_id+' Submitted Successfully.')
            //             console.log(res);
            //             view_pick_slip();
                        
            //             }).catch(function(){
            //             })
            // }

            function view_pick_slip(){
            order_number = $('#order_number').val()
            tab_url = "/setup/conc_prog?order_number="+order_number;
            let tab_title2 = 'ViewRequest#'+order_number ;
            let unique_name = 'Concprog'+order_number; //(Math.random() + 1).toString(36).substring(7)
            var data = ['createTab', tab_title2 , tab_url, unique_name , true ]
            var event = new CustomEvent('addOpenIframePage', { detail: data })
            window.parent.document.dispatchEvent(event)
            }
</script>
<script>
    // function getItemDetail() {
    //     var data = $('#excel_data').val();
    //     rows = data.split("\n");
    //     items_code = []
    //     $.each(rows, function(index, value) { 
    //         row_data = value.split("\t")
    //         if(row_data[0] != 'Item Code'){
    //             item=row_data[0]+'/'+row_data[1]
    //             items_code.push(item)
    //         }
    //     });
    //     axios.get("/saleswores/search_items?&items="+items_code)
    //     .then(function(res)
    //     {
    //         var tbl='#sp_products'
    //         datatable_reload2(res,tbl);
    //     })
    //     .catch(function()
    //     {
           

    //     })
    // }

// Add a request interceptor
axios.interceptors.request.use(function (config) {
    // Do something before request is sent

    return config;
    }, function (error) {
    // Do something with request error

    return Promise.reject(error);
});

// Add a response interceptor
axios.interceptors.response.use(function (response) {
    // Any status code that lie within the range of 2xx cause this function to trigger
    // Do something with response data
    return response;
}, function (error) {


    // toastr.error(error.response.data);
    // HideDIV();

    HideDIV();
    toastr.error("Please contact ITS !")
    toastr.error(error.response.data);
    toastr.error(error.response.data.exception);
    toastr.error(error.response.data.response);


    

    // setTimeout(function(){
    //     toastr.error("Timeout threshold limit exceeded ! ");
        
    // },1000 * 120);


    // Any status codes that falls outside the range of 2xx cause this function to trigger
    // Do something with response error
    return Promise.reject(error);
});

</script>
<script>

    
function getItemStock(){
    if((shoppingCart.listCart()).length > 0){
        shoppingCart.clearCart()
    }

    // items_code = []
    // var pastedData = $('#excel_data').val();
    // var data = pastedData.split("\t")
    // $.each(data, function(index, value) {
    //     if(value.search("1\n") == 0){
    //             testing = value.split("1\n")
    //             value= testing[1]
    //     }
    //     items_code.push(value)
    // });
    // console.log(items_code.length)

    items_code= [].slice.call($('#sp_product_id tr td.row_item_code'))
                .map(
                    (x)=>
                        $(x).text()
                        +'/'
                        +$(x).closest('tr').find('.row_qty').val()
                ).join();
    items_code = [items_code];
    update_datatable2(items_code);
}


var glo_doc_ids = [];
var glo_documents_uploaded = false;
function uploadDocuments(e) {
    const frontInput = document.getElementById('front');
    const backInput = document.getElementById('back');
    const docTypeInput = document.getElementById('doc_type');
    const docNameInput = document.getElementById('doc_name');
    const expDateInput = document.getElementById('exp_date');
    
    const formData = new FormData();
    formData.append('front', frontInput.files[0]);
    formData.append('back', backInput.files[0]);
    formData.append('doc_type', docTypeInput.value);
    formData.append('doc_name', docNameInput.value);
    formData.append('exp_date', expDateInput.value);
    
    formData.append('customer_number', $('#searchCust').select2('data')[0].cust_account_id);
    
    
    
    if (!frontInput.files[0] || !backInput.files[0]) {
        toastr.error('Please attach both the front and back files.');
        return;
    }
    
    // if (!expDateInput.value) {
    //     toastr.error('Please enter the expiry date.');
    //     return;
    // }
    if (!docNameInput.value) {
        toastr.error('Emirates ID number missing.');
        return;
    }
    
    e.disabled = true;
    ShowDIV(["Uploading Documents"]);
    axios.post('/saleswores/uploadDocuments', formData, {
        headers: {
            'Content-Type': 'multipart/form-data'
        }
    })
    .then(response => {
        HideDIV();
        console.log(response.data);
        glo_documents_uploaded = true;
        toastr.success('Documents Uploaded !');
        glo_doc_ids = response.data.doc_ids;

    })
    .catch(error => {
        HideDIV();
        console.error(error);
    });
}


</script>


<div class="card" id="asc" hidden>
           
    <div class="card-header" id="headingOne">
         <h2 class="mb-0">
             <button type="button" class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseOne">2. Search Stock</button>									

             <button type="button" class="btn btn-info" onclick="scanBarcode()" >Scan Barcode</button>

             <button type="button" class="btn btn-info" onclick="clearBarcode()">Clear Barcode</button>	

             <script>
                 function clearBarcode() {
                    $('[type="search"]').val("");
                 }
                 var orgdisplayDivInfo;
                 function scanBarcode(){


                    var displayDivInfo = [].slice.call($('.container-fluid div')).map(x=>[x,x.style.display]);
                    orgdisplayDivInfo = displayDivInfo;
                    displayDivInfo.forEach(x=>{
                        if (x[0].id != 'cancelScan')
                            x[0].style.display = 'none';
                    });
                    
                    
                    
                    $('#cancelScan').show()
                    $('#reader').show();
                    new Html5Qrcode.getCameras().then(devices => {
                            if (devices && devices.length) {
                                var html5QrcodeScanner = new Html5Qrcode('reader', false);
                                // html5QrcodeScanner.render(onScanSuccess);

                                html5QrcodeScanner.start(devices[1].id, {
                                    fps: 10,
                                    qrbox: 250,
                                    aspectRatio: 1.5
                                }, success => {
                                    console.log(success);
                                    html5QrcodeScanner.stop();
                                    displayDivInfo.forEach(x=>{
                                        x[0].style.display = x[1];
                                    })
                                    $('#reader').hide();
                                    $('#cancelScan').hide();
                                    if ($('button:contains("2. Search Stock")').hasClass("collapsed")){
                                        $('button:contains("2. Search Stock")').click();
                                    }
                                    
                                    // $('[type="search"]').val().trigger("input")

                                    $('[placeholder="Search Barcode"]').val(success.trim()).trigger('change')
                                    
                                });

                            }
                        })
                            
              

                    //
                 }

                 function cancelScan(){
                    orgdisplayDivInfo.forEach(x=>{
                        x[0].style.display = x[1];
                    })
                    $('#reader').hide();
                    $('#cancelScan').hide();
                    if ($('button:contains("2. Search Stock")').hasClass("collapsed")){
                        $('button:contains("2. Search Stock")').click();
                    }
                    

                 }
             </script>								
        
             <!-- <span id="selected_item" style="float: right;font-size: 16px;color: green;padding-top: 12px;"></span> -->
            </h2>
     </div>
<div id="collapseOne" class="collapse" aria-labelledby="headingOne">
<div class="card-body">

<!-- <p>HTML stands for HyperText Markup Language. HTML is the standard markup language for describing the structure of web pages. <a href="https://www.tutorialrepublic.com/html-tutorial/" target="_blank">Learn more.</a></p> -->



<div class="block-finder__title text-dark" style="    font-size: 20px;
font-weight: bold; display: none;">ITEM DETAILS</div>
<!-- <br> -->
<!-- <select class="initSelc2 " >
<option></option>
</select> -->

<button  type="button" class="add-to-cart pull-right btn btn-sm btn-info" style="display: none;" onclick="" >Add To Cart <i style="color: white;" class="fa fa-cart-plus fa-1x "  aria-hidden="true"></i></button> 
<!-- <br><br> -->
<style>

.dataframe >thead > tr {


    text-align: center !important;
}

.dataframe >thead > tr  > th {

    border: 1px solid !important;

}


table.dataTable thead>tr>th
{

/* font-size: 14px; */
}
table.table-bordered.dataTable tbody td
{

/* font-size: 14px; */
}
</style>

<div class="table-responsive" style="display: none;">

<table class="table table-bordered table-hover w-100 table-hover tbl_font table-sm "   style="    white-space: nowrap;"  id="pre_filter"></table>

</div>


<!-- <div id="vProductTbl"> -->
<!-- <div class="products-view__list products-list products-list--grid--4" data-layout="table"
 data-with-features="false"> -->
 
 <div class="table-responsive " >
     
     <table id="search-tbl" class="tbl_font table table-sm" style="white-space: nowrap; width: 100%;">
         
     </table>

 <!-- </div> -->

<!-- </div> -->
</div>



<style>

#cash_collection{  width: 100% !important;   }


#products_wrapper > div:nth-child(2) > div
{
    overflow: scroll !important;
}
#sp_products_wrapper > div:nth-child(2) > div
{
    overflow: scroll !important;
}

#show-cart-parent_div{
    overflow: scroll;
}





.lbl_qty_count{


text-align: right;
color: #007bff;
}


</style>



<h3> Available Stock </h3>
<div class="table-responsive" style="    border: 1px solid;" >
<p id="sum"></p>
<!-- <table class="table tbl_font table-hover table-sm dataTable"   style="white-space:nowrap;"  id="products"></table> -->
</div>





</div>
</div>
 </div>


 <div class="card" hidden>
    <div class="card-header" id="headingTwo">
        <h2 class="mb-0">
            <button type="button" class="btn btn-link collapsed" data-toggle="collapse" data-target="#collapseTwo" onclick="Preview_Order()"> 3. Preview Order </button>
        




             <a type="button" id="inv_href" target="_blank"  href="#" class="btn btn-sm waves-effect waves-light cart-btn btn-primary d-none" aria-expanded="true"   style="    float: right;
             margin-top: 7px;  margin-left: 39px;">               

                
                
              View Transfers List (<span class="inv_transfer_qty_selected">0</span>)
            </a>

         

            <span class="fa-stack fa-1x has-badge collapsed back-to-top" data-count="0"   data-toggle="collapse" data-target="#collapseTwo"   id="qty_selected" onclick="Preview_Order()" >
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-shopping-cart fa-stack-1x fa-inverse float"></i>
             </span>
<style>


#qty_selected
{
    cursor: pointer;
    zoom: 0.7;
    float: right;

}
    .fa-stack[data-count]:after {
    position: absolute;
    right: 0%;
    top: 0%;
    content: attr(data-count);
    font-size: 40%;
    padding: 0.6em;
    border-radius: 999px;
    line-height: 0.75em;
    color: white;
    color: green;
    text-align: center;
    min-width: 2em;
    font-weight: bold;
    background: white;
    border-style: solid;
    }

    .fa-circle 
    {
    color: green;
    }

    .red-cart {
    color: green;
    background: white;
    }

</style>



        </h2>
    </div>
    <div id="collapseTwo" class="collapse" aria-labelledby="headingTwo">
        
    </div>

</div>




<!-- <div id="reserved_stock" class="common_area_cls table-responsive" >

   
    <table   class="table table-bordered table-hover table-hover tbl_font table-sm"  style="    white-space: nowrap;"     id="tbl_reserved_stock"></table>

</div> -->





<style>
    .pull-left{float:left!important;
        width: 75%;
        margin-bottom: 40px;
    }
    .pull-right{float:right!important;}
    #search-tbl_filter{
    
        width: 90%;
    }
    #search-tbl{
        border: 1px solid;
    
    }
    #search-tbl_filter label
    {
            width: 100%;
    }
    #search-tbl_filter label input
    {
            width: 97%;
            height: 47px;
            font-size: 20px;
    }
    #search-tbl_length > label > select
    {
        height: 47px;
        font-size: 20px;
            
    }


    
#search-tbl > tbody > tr:hover{
    background-color: rgba(41, 103, 182, 0.89);
    color: #FFF !important;
    cursor: pointer;
}
#search-tbl > tbody > tr.selected 
{
    background-color: rgba(41, 103, 182, 0.89);
    color: #FFF;
}

#serach_based_on_type+span span span{

    font-size: 12px;
    padding: 0px;
    padding-left: 6px;
}
    </style>
{% endblock %}


{% block script_block %}


<script>
$('#exp_date').flatpickr({
    enableTime: false,
    dateFormat: "d-M-Y",
    
});

let validationsPassed = false;

var counts_row=new Vue({
      el: '#counts_row',    
      delimiters:['[[',']]'], 
      data:
      {
        data: {{counts|safe}} 
      },
      methods: 
      {
      },  
  });
 





  var table_1;
  localStorage.setItem('defs','{{defs|safe}}')

  

  $(function()
  {


    //var abccccc=1
      try
      {
        var a=JSON.parse(localStorage.getItem('defs'))

        // $('#dep_amt').val(a.reservation_amount)
     }
     catch(error)
     {


     }

        //reservation_amount
        //axios.get("/sales/sd"+window.location.search+'&organization_code='+a['organization_code'])
		// axios.get("/sales/sd"+window.location.search)
        // .then(function(res)
        // {
		// 	// vProductTbl.columns = res.data.columns;
		// 	//initDT(res.data)
		// 	$('#search-tbl').append(buildTheadTfoot(res.data.columns));
		// 	var columnsMeta =res.data.columns.map(x=>x.data);


		// 	table_1=$('#search-tbl').DataTable({
		// 		"processing": true,
        //         "serverSide": true,
        //         "language": 
        //         {
        //             processing: '<i class="fa fa-spinner fa-spin fa-3x fa-fw"></i><span class="sr-only">Loading..n.</span> '
        //         },
        //         "deferLoading": 0,
        //         "dom": '<"pull-left"f><"pull-right"l>tip',
		// 		colReorder: true,
        //        // "pageLength": 10,
        //         "oLanguage":
        //         {
        //             "sSearch": "Item Search :"
        //         },
        //         "destroy": true,               
        //         columnDefs:[
        //             {
        //                 targets:res.data.hcols,
        //                 visible:false
        //             }
        //         ],
        //         preDrawCallback: function(settings,json) {
		// 					//Should I put it here?
        //                    // alert(1)
                           
        //                 //this.context[0].jqXHR.abort()
        //                      try 
        //                      {
        //                         $(this).dataTableSettings[0].jqXHR.abort()
        //                     } 
        //                     catch (error) 
        //                     {
        //                         console.log(error);
                        
        //                     }

                       
        //                // table_1.context[0].jqXHR.abort()
        //         },
		// 		"ajax":{
		// 			type:"POST",
        //             'beforeSend': function (request) {
        //                 showloader('Searching.... Please wait... <button class="btn btn-sm btn-light" onclick="hideloader()"> Cancel </button>')
        //             },
        //             xhr: function() {
        //             var xhr = $.ajaxSettings.xhr();
        //             xhr.upload.onprogress = function(e) 
        //             {
        //                // xhr.abort(); //abort all current request here
        //               // table_1.settings()[0].jqXHR.abort()
        //                //alert(23)
        //             };
        //             return xhr;
        //             },
		// 			url:"/sales/sd",
		// 			headers: {'X-CSRFToken': '{{ csrf_token }}'},
                    
        //         data : 
        //         {
        //         	's':'{{s}}',
        //             columnsMeta:JSON.stringify(columnsMeta),
        //             'defs':localStorage.getItem('defs')
                  

        //         },
		// 		},
		// 		drawCallback:function(d)                
        //         {
        //             hideloader();

		// 			// alert($('#search-tbl_filter input').val());
        //         //    console.log(d)
		// 			var sT= getCurUrlGETObj().s;				
        //             if (sT != $('#search-tbl_filter input').val())
        //             {
		// 				var toFind= $('#search-tbl_filter input').val().toLowerCase();						
        //             } else
        //             {
		// 				$('#search-tbl_filter input').val("{{s}}");
		// 				var toFind= "{{s}}".toLowerCase();
		// 			}
		// 			$('#search-tbl td').each(function()
        //             {
						
		// 				if ($(this).text().toLowerCase().indexOf(toFind) > -1)
        //                 {

		// 					var s= $(this).text().toLowerCase();
		// 					var start = s.indexOf(toFind);
		// 					var end = start + toFind.length;
		// 					var html = $(this).text().slice(0,start)+'<span class="font-weight-bold">'+$(this).text().slice(start,end)+'</span>'+ $(this).text().slice(end);
							
		// 					$(this).html(html)

		// 				}
		// 			})

		// 		},                 
        //         initComplete: function () 
                
        //         {

        //             var i=0;
        //              this.api().columns().every( function () 
        //             {

        //                 i++;
        //                 var a=Math.floor(Math.random() * 11);
        //                 var column = this;		
        //                 if(i==5)
        //                 {
        //                     $(column.footer()).append("<br>")
        //                     $(column.footer()).html(' ')

        //                     var select = $('<select id='+i+a+'   style="width: 100%;    padding: 3px;">'+res.data.business+'</select>')
        //                     .appendTo($(column.footer()))
        //                     .on('change', function () 
        //                     {
        //                         // var val = $.fn.dataTable.util.escapeRegex(
        //                         // $(this).val());
        //                     })

        //                 }


        //                 var that = this;	
        //                 console.log(that)	;
        //                 $( 'select', this.footer()).on( 'keyup change clear', function () 
        //                 {       
        //                     console.log(that)                     
        //                     if ( that.search() !== this.value ) 
        //                     {
		// 						that.search(this.value).draw();
		// 					}
		// 				});

                                                       

		// 				var that = this;	
        //                 console.log(that)	;
        //                 $( 'input', this.footer()).on( 'keyup change clear', function () 
        //                 {       
        //                     console.log(that)                     
        //                     if ( that.search() !== this.value ) 
        //                     {
		// 						that.search(this.value).draw();
		// 					}
		// 				});
        //             });
                    
		// 		}	

		// 	})
        // });    

        var temp1; $('#search-tbl').on( 'click', 'tr', function (e) 
        {
            console.log('#')
            console.log( table_1.row( this ).data());
            $('#search-tbl > tbody > tr').children('td').css('color','black');
            $('#search-tbl > tbody > tr').children('td').css('background-color','transparent');         
            $(e.currentTarget).children('td').css('background-color','rgba(41, 103, 182, 0.89)');
            $(e.currentTarget).children('td').css('color','white');
            console.log('#')
            temp1=table_1.row( this ).data()      
            console.log('232323')  
            console.log(temp1)  
            console.log('232323')  

            try
             {
                     update_datatable(temp1[0])       
            } catch (e)
             {
                console.log('error in page ')  
          
            }

               
                           
        }); 
	});
</script>

<script src="{% static 'custom_js/saleswores.js' %}?v={{STATIC_ASSET_VERSION}}"></script>
<script src="{% static 'custom_js/cart.js' %}"></script>

<script src="{% static 'custom_js/inventroy_cart.js' %}"></script>

<script src="{% static 'custom_js/sum().js' %}"></script>


<script>

(function($){
    $.widget("suwala.doubleScroll", {
		options: {
            contentElement: undefined, // Widest element, if not specified first child element will be used
			topScrollBarMarkup: '<div class="suwala-doubleScroll-scroll-wrapper" style="height: 20px;"><div class="suwala-doubleScroll-scroll" style="height: 20px;"></div></div>',
			topScrollBarInnerSelector: '.suwala-doubleScroll-scroll',			
			scrollCss: {                
				'overflow-x': 'scroll',
				'overflow-y':'hidden'
            },
			contentCss: {
				'overflow-x': 'scroll',
				'overflow-y':'hidden'
			}
        },		
        _create : function() {
            var self = this;
			var contentElement;

            // add div that will act as an upper scroll
			var topScrollBar = $($(self.options.topScrollBarMarkup));
            self.element.before(topScrollBar);

            // find the content element (should be the widest one)			
            if (self.options.contentElement !== undefined && self.element.find(self.options.contentElement).length !== 0) {
                contentElement = self.element.find(self.options.contentElement);
            }
            else {
                contentElement = self.element.find('>:first-child');
            }

            // bind upper scroll to bottom scroll
            topScrollBar.scroll(function(){
                self.element.scrollLeft(topScrollBar.scrollLeft());
            });
			
            // bind bottom scroll to upper scroll
            self.element.scroll(function(){
                topScrollBar.scrollLeft(self.element.scrollLeft());
            });

            // apply css
            topScrollBar.css(self.options.scrollCss);
            self.element.css(self.options.contentCss);

            // set the width of the wrappers
            $(self.options.topScrollBarInnerSelector, topScrollBar).width(contentElement[0].scrollWidth);
            topScrollBar.width(self.element[0].clientWidth);
        },
        refresh: function(){
            // this should be called if the content of the inner element changed.
            // i.e. After AJAX data load
            var self = this;
			var contentElement;
            var topScrollBar = self.element.parent().find('.suwala-doubleScroll-scroll-wrapper');

            // find the content element (should be the widest one)
            if (self.options.contentElement !== undefined && self.element.find(self.options.contentElement).length !== 0) {
                contentElement = self.element.find(self.options.contentElement);
            }
            else {
                contentElement = self.element.find('>:first-child');
            }

            // set the width of the wrappers
            $(self.options.topScrollBarInnerSelector, topScrollBar).width(contentElement[0].scrollWidth);
            topScrollBar.width(self.element[0].clientWidth);
        }
    });
})(jQuery);


$('#sp_products').closest('.table-responsive').doubleScroll();


$('#showitemid').hide();
vDash= new Vue({
    delimiters: ['[[', ']]'],
    el: '#v-dash',
    data(){
    return {   

            info:{},
            dashInfo:[],
            ret_line_data:[],
            pdi_line_activities:[],
            pdi_line_activities_lov:[],
            pdi_line_id:'',
            ret_line_col:[],
            ret_type:[],
            ret_line_reason_lov:[],
            ret_line_type:[],
            order_line_data:[],
            order_line_col:[],
            related_lines_data : [],
           
            't':'0',
            'td':'0',
            'tv':'0',
            'gt':'0',
            'vat_p':'',
            'et':'0'

           
        }
    },
    mounted(){
       
       
    },
    computed: {

    },
    methods: {
    }
});

var usingMob = false;
var items = [];


    $("#sales_order_div").hide();
    $('#products').hide();	
    $("#sp_products").bind("paste", function(e){
        
        ShowDIV(["Getting Item information..."]);

        var pastedData = e.originalEvent.clipboardData.getData('text');
        if(jQuery.inArray("\r", data) !== -1){
            alert("in if")
        }else{
            testing = pastedData;
            var data = testing.split("\n").filter(x=> x!="").map(x=> !x.trim().includes("\t") ? x.trim()+'/1' :x.trim() );
        }
        rows = data;

        items = rows.map(text=>text.replace("\t","/"));

        quantity = items.map(text=> ({ [text.split("/")[0]]:{quantity:text.split("/")[1]} })).reduce ((a,b) => Object.assign(a,b),{})

        NewArray = items.filter(x=>true);
    
    

        $("#excel_data").val(NewArray)

        console.log(rows);
        console.log(items);
        console.log(quantity);
        console.log(NewArray);
        // debugger;


        axios.get("/saleswores/search_items?&items="+NewArray)
        .then(function(res)
        {
            HideDIV();

            console.log(res.data.data)
            console.log(res.data.not_found)
            var html = ""
            var html1 = ""
            customer_vat = $('#customer_vat').val()
            var rowCount = $('#sp_product_id tr').length;
            $.each(quantity, function(index1, value1) {
                $.each(res.data.data, function(index, value) {
                    console.log('itemsMapping[value.item_code]', value.item_code,'value.inventory_item_id', value.inventory_item_id)
                    itemsMapping[value.item_code] = value.inventory_item_id
                    if($("#"+value.item_code).html()){
                        console.log("in if")
                    }else{
                        itemsMapping[value.item_code] = value.inventory_item_id
                        if(index1 ==  value.item_code){
                            new_vat = "00.00"
                            if(customer_vat){
                                total = (value1.quantity * Number(value.price).toFixedRound(2))
                                vat_per = (customer_vat / 100)
                                new_vat = (Number(total).toFixedRound(2) * Number(vat_per).toFixedRound(2)) 
                            }
                            discount_val = ""
                            let discount_perc = 0.0
                            if(value.discount != 0){
                                discount_p= value.discount
                                price = value.price
                                discount = (price * discount_p)
                                selling_price = price - discount
                                discount_val = (discount * value1.quantity).toFixedRound(2)
                            }else{
                                selling_price = value.price
                                discount_val = "00.00"
                                discount_p = 0
                            }
                            console.log(new_vat)
                                    total_li_price = (value1.quantity * selling_price)
                                    console.log(Number(total_li_price) + Number(new_vat))
                            rowCount =  (rowCount + 1)
                            html += `<tr id=`+value.item_code+`>`
                            html += `<td><button class="delete-item btn btn-sm btn-danger" style="margin-right: 10px;" "+stylehide_btn_remove+"  data-name=`+value.item_code+`><i class="right fas fa-times"></i></button><button   style='display:none;background-color:transparent; font-size: 11px;color: white;padding: 7px 7px;' class=`+value.item_code+` id='blink-bg'></button></td>`
                            html += `<td>`+rowCount+`</td>`
                            html += `<td>`+(value.barcode === null ? "":value.barcode )+`</td>`
                            html += `<td class="row_item_code">`+value.item_code+`</td>`
                            html += `<td>`+value.description+`</td>`
                            html += `<td>`+value.primary_unit_of_measure+`</td>`
                            html += '<td id="res_quantity'+value.item_code+'"></td>' 
                            html += `<td> <input type="number"  class="row_qty" oninput="event.target.value = event.target.value.replace(/[^0-9]*/g,'');" style="width:50%" id="quantity`+value.item_code+`" item_code="`+value.item_code+`" onblur="updateQuantity(this)" value="`+value1.quantity+`"></td>`
                            html += '<td id="list_price'+value.item_code+'">'+Number(value.price).toFixedRound(2)+'</td>'
                            html += `<td><input type="number" style="width:50%" id="price`+value.item_code+`" readonly disabled item_code="`+value.item_code+`" onblur="updatePrice(this)" value="`+Number(selling_price).toFixedRound(2)+`"></td>`
                            html += `<td><input type="number" style="width:50%" id="dis_val${value.item_code}" data-discount="${discount_p}" item_code="${value.item_code}" onblur="updateDiscount(this)" value="${discount_p}" ></td>`
                            {% comment %} html += '<td id="dis_val'+value.item_code+'" data-discount="'+discount_p+'">'+Number(discount_val).toFixedRound(2)+'</td>' {% endcomment %}
                            html += `<td id="dis_perccc${value.item_code}">${Number(discount_perc).toFixedRound(2)}</td>`
                            html += '<td id="vat'+value.item_code+'">'+Number(new_vat).toFixedRound(2)+'</td>'
                            html += '<td id="total_price'+value.item_code+'">'+Number(Number(total_li_price) + Number(new_vat)).toFixedRound(2)+'</td>'
                            html += '<td><input type="hidden" id="total_exc_vat'+value.item_code+'" value="'+Number(selling_price).toFixedRound(2)+'" /></td>'
                            html += `</tr>`
                        }
                    }
                    
                });
            })
            $('#sp_product_id').append(html)
            console.log(res.data.not_found)
            console.log((res.data.not_found).length)
            $.each(res.data.not_found, function(ind1, val1) {
                console.log(val1)
                if(val1 != ""){
                    if($("#"+val1).closest('tr').attr('id')){
                            console.log("in if")
                    }else{
                        rowCount =  (rowCount + 1)
                        html1 += `<tr style="color:red" id=`+val1+`>`
                        html1 += `<td><button class="delete-item btn btn-sm btn-danger" style="margin-right: 10px;" "+stylehide_btn_remove+"  data-name=`+val1+`><i class="right fas fa-times"></i></button></td>`
                        html1 += `<td>`+rowCount+`</td>`
                        html1 += `<td></td>`
                        html1 += `<td>`+val1+`</td>`
                        html1 += `<td>Not found</td>`
                        html1 += `<td></td>`
                        html1 += `<td></td>`
                        html1 += `<td></td>`
                        html1 += `<td></td>`
                        html1 += `<td></td>`
                        html1 += `<td></td>`
                        html1 += '<td></td>'
                        html1 += '<td></td>'
                        html1 += '<td></td>'
                        html1 += `</tr>`
                        console.log("=======")
                    }
                }
                });
                $('#sp_product_id').append(html1)
            
            total_records = $('#sp_product_id tr').length;
            $('#total_records').html(total_records)
            $("#sp_products_item_code")[0].value = ""
            var delay = 1000;
            setTimeout(function() {
                getInvoiceTotal()
            },delay)

        })
        .catch(function()
        {
            HideDIV();


        })
        var delay = 1000;
        setTimeout(function() {
            getInvoiceTotal()
        },delay)
    } );
        
$(document).ready(function()
{
    
    $(function () {
        $('[data-toggle="popover"]').popover()
    })
    id=$('#customer_id_id').val()
    if(id){ 
        text =$('#customer_tet').val()
        customer_name =$('#customer_customer_name').val()
        customer_number =$('#customer_customer_number').val()
        var data ={
            id:id,
            text:text,
            customer_number:customer_number,
            customer_name:customer_name
        };
        var newOption = new Option(data.text, data.id, false, false);
        $('#searchCust').append(newOption).trigger('change');
        $('#searchCust').trigger({
            type: 'select2:select',
            params: {
                data: data
            }
        });

        quotation_items = $('#quotation_item').html()
        console.log(quotation_items)
        row = quotation_items.split(",")
        $.each(row, function(index, value) {
            items.push(value)
        })
        $('#excel_data').val(items)
        console.log(items)
        total_records = $('#sp_product_id tr').length;
        $('#total_records').html(total_records)
    }
// function quotationVat(vat){
//     items_code = []
//     var pastedData = $('#excel_data').val();
//     var data = pastedData.split("\t")
//     $.each(data, function(index, value) {
//         item = value.split(",")
//         $.each(item, function(index1, value1) {
//             var data1 = value1.split("/")
//             items_code.push(data1[0].replace(/\n/g,""))
//         });
//     });
//     customer_vat = $('#customer_vat').val()
//     $.each(items_code, function(index1, value1) {
//         $.each(value1, function(index2, value2) {
//             console.log(value2)
//             new_vat = "00.00"
//             if(customer_vat){
//                 quantity = $('#quantity'+value2).val();
//                 price = $('#price'+value2).val()
//                 total = (quantity * price).toFixedRound(2)
//                 vat_per = (customer_vat / 100)
//                 new_vat = (total * vat_per).toFixedRound(2)  
//             }
//             console.log($('#vat'+value2).html())
//             console.log(new_vat)
//             $('#vat'+value2).html(new_vat)
//         })
//     })
//     getInvoiceTotal()
// }

    // if( /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
    //         usingMob = true;
    // }
    //     shoppingCart.clearCart();
    //     $('#temp_order_number_to_oracle_order').val("");  



    // // var defs= localStorage.getItem('defs')       	  
    // // axios.get("http://192.168.16.150:6323/python_api/get_forms.php?defs="+defs+'&uid=12445')
    // //  .then(function (response) 
    // //  {
    // //      console.log(response)
           
    // //        $('#data').append(response.data);
           
          
    // //  })
    // //  .catch(function (error) {
    // //    // handle error
    // //    alert(error);
    // //  })
    // //  .finally(function () {
    // //    // always executed
    // //  });  
    // FisherMan();
 });


function FisherMan()
{

    var queryString = window.location.search;
    var urlParams = new URLSearchParams(queryString);
    var  discount_id = urlParams.get('discount_id')
    //alert(discount_id)
    if(discount_id!='' &&  discount_id!=null)
    {

                axios.get("fisher_man_validation?discount_id="+discount_id)
                .then(function (response) 
                {
                        console.log(response)
                        dt=response.data

                       if (dt.msg !='null')
                       {
                            toastr.info(dt.msg)
                            return 
                       }


                        var data =
                        {
                            id:dt.cust_account_id,
                            text:dt.customer_name,
                            customer_number:dt.account_number,
                            customer_name:dt.customer_name
                        };

                        var newOption = new Option(data.text, data.id, false, false);
                        
                        $('#searchCust').append(newOption).trigger('change');

                        $('#searchCust').val(dt.cust_account_id).trigger('change');
                        $('#searchCust').select2('data')[0]['customer_name']=dt.customer_name;
                        $('#searchCust').select2('data')[0]['customer_number']=dt.account_number;


                        document.getElementById('main_cust').value=dt.customer_name;
                        document.getElementById('main_customer_number').value=dt.customer_number;
                        document.getElementById('main_customer_id').value=dt.cust_account_id;     

                        
                        

                        // var newOption = new Option(dt.customer_name, dt.cust_account_id, false, false);
                        // $('#searchCust').append(newOption).trigger('change');

                        $('#customer').append('<option value="'+dt.cust_account_id+'">'+dt.customer_name+'</option>')

                        $('#customer_bill').append('<option value="'+dt.cust_account_id+'">'+dt.customer_name+'</option>')


                        // $('#searchCust').val(dt.cust_account_id).trigger('change') 

                        // $('#searchCust').select2('data')[0]['customer_name']=dt.customer_name;
                        // $('#searchCust').select2('data')[0]['customer_number']=dt.customer_number;


                     


                        $('#customer').val(dt.cust_account_id);

                        $('#customer_bill').val(dt.cust_account_id);

                        $('#shiptocust').val(dt.customer_name)

                        $('#billtocust').val(dt.customer_name)

                        $('#sel_cust').html(dt.customer_name);


                        cust_disc_perc= dt.cust_disc_perc

                        actual_bal_amount= (parseFloat(dt.actual_bal_amount)).toFixedRound(2) 

                        customer_limit= (parseFloat(dt.customer_limit)).toFixedRound(2) 

                        $('#sel_cust').prepend(' <br>Discount Max Percentage :'+ cust_disc_perc+' <br>'); 

                        $('#sel_cust').prepend('Available Limit (AED): '+ actual_bal_amount+' ');

                        

                       // 16: show place holder on the input fields 

                        $('#avlable_stock').prepend("<marquee>This customer is selected for disacount</marquee>")

                        $('#cust_disc_perc').val(cust_disc_perc)


                        $('#discount_id').val(discount_id)


                        

                        $('#actual_bal_amount').val(actual_bal_amount);
                        $('#customer_limit').val(customer_limit);

                        //


                        $('#searchCust').prop('disabled', true);
                        $('#customer').prop('disabled', true);
                        $('#customer_bill').prop('disabled', true);


                        
                        cust_account_id_(dt.cust_account_id)
                       
                        //get_tax_()

                        

                })
                .catch(function (error) 
                {
                        alert(error);
                })
                .finally(function () 
                {
               
                });  

    }


}



var selected_customer=''
function cust_account_id_(id)
{
    //alert(1)
    axios.get("/sales/get-customer-data?caid="+id+"&defs="+localStorage.getItem('defs'))
      .then(function(res)
      {
  
         //customer_infoo
        
         document.getElementById('customer_infoo').innerHTML='<div class="row" id="customer_infoo_tbl" hidden> <label for="name" class="col-sm-4" style="margin-bottom:0px" >Name :</label><span class="col-sm-8"  >'+res.data.hdr.customer_name+'</span></div><div class=" row"><label class="col-sm-4"  for="name" style="margin-bottom:0px"> Customer #: </label><span  class="col-sm-8"   style="color: #007bff;text-decoration: none; background-color: transparent;cursor: pointer;" onclick="customer_history('+ res.data.hdr.account_number +')" >'+ res.data.hdr.account_number +'</span></div> <div class=" row "><label class="col-sm-4"  for="name" style="margin-bottom:0px">Email :</label><span class="col-sm-8"  >'+res.data.hdr.email_id+'</span></div><div class=" row "><label style="margin-bottom:0px" for="name" class="col-sm-4"> Mobile : </label><span class="col-sm-8" >'+res.data.hdr.mob_no+'</span></div>';
         //$('#sel_cust').html(res.data.hdr.customer_name);
      
      //document.getElementById('selected_cust').innerHTML='<b> Customer Name :</b> '+res.data.hdr.customer_name+'<br>';
  
      //document.getElementById('selected_cust_account').innerHTML='<b> Customer Number :</b>'+ res.data.hdr.account_number+'<br>';
  
  
     // document.getElementById('selected_cust_email').innerHTML='<b> Customer Email :</b> '+res.data.hdr.email_id+'<br>';
  
     // document.getElementById('selected_cust_phone').innerHTML='<b> Customer Mobile :</b> '+res.data.hdr.mob_no;
  
      
      
  
      //console.log(res.data)
      selected_customer=res.data;           
  
    //   for (var k in formDetails.data)
    //   {
    //   if (formDetails.data[k] == null)
    //   {
    //          formDetails.data[k] = '-';
    //   }
    //   }
  
          //http://lp00735/cust/get-customer-data?caid=3579
      $("#available_customer_address_div").removeClass('d-none');    
      var out='';
      for(var i=0;i<res.data.lines_data.data.length;i++)
      {
             // out+='<option value="'+res.data.lines_data.data[i][2]+'">'+res.data.lines_data.data[i][2]+'</option>';
  
             // alert(res.data.lines_data.data[i][9])
  
      if(res.data.lines_data.data[i][9]=='SHIP_TO')
      {   
          var $select = $('#customer');
          $select.empty();                     
          $select.append("<option value="+res.data.lines_data.data[0][14]+">"+res.data.lines_data.data[0][12]+"</option>"); 
  
  
        //   var $select = $('#number');
        //   $select.empty();                     
        //   $select.append("<option value="+res.data.lines_data.data[0][11]+">"+res.data.lines_data.data[0][11]+"</option>"); 
  
  
                  // document.getElementById('number').value=res.data.lines_data.data[i][11];
  
  
                  //document.getElementById('customer').value=res.data.hdr_data.data[0][7];
                //   document.getElementById('location').value=res.data.lines_data.data[i][10];
  
                //   document.getElementById('address').value=res.data.lines_data.data[i][2];
                //   document.getElementById('address_2').value=res.data.lines_data.data[i][3];
                //   document.getElementById('address_3').value=res.data.lines_data.data[i][4];
  
                //   document.getElementById('area').value=res.data.lines_data.data[i][6];
                //   document.getElementById('country').value=res.data.lines_data.data[i][8];
                //   document.getElementById('contact').value=res.data.lines_data.data[i][13];
                 // alert(3333)
                 // alert(2)
                //   console.log(res.data.lines_data.data[i])

                
               // document.getElementById('ship_to_customer_infoo').innerHTML='<div class=" row" id="customer_infoo_tbl"> <label for="name" class="col-sm-4" >Name :</label><span class="col-sm-8"  >'+res.data.hdr.customer_name+'</span></div><div class=" row"><label class="col-sm-4"  for="name"> Customer #: </label><span  style="color: #007bff;text-decoration: none; background-color: transparent;cursor: pointer;" onclick="customer_history('+ res.data.hdr.account_number +')" >'+ res.data.hdr.account_number +'</span></div> <div class=" row "><label class="col-sm-4"  for="name">Email :</label><span>'+res.data.hdr.email_id+'</span></div><div class=" row "><label for="name" class="col-sm-4"> Mobile : </label><span>'+res.data.hdr.mob_no+'</span></div>';
  
                document.getElementById('ship_to_customer_infoo').innerHTML='<div class=" row" id="customer_infoo_tbl" hidden> <label for="name" class="col-sm-4" style="margin-bottom:0px">Name :</label><span class="col-sm-8"  >'+res.data.hdr.customer_name+'</span></div><div class=" row"><label class="col-sm-4"  for="name" style="margin-bottom:0px"> Customer #: </label><span  class="col-sm-8"   style="color: #007bff;text-decoration: none; background-color: transparent;cursor: pointer;" onclick="customer_history('+ res.data.hdr.account_number +')" >'+ res.data.hdr.account_number +'</span></div> <div class=" row "><label class="col-sm-4"  for="name" style="margin-bottom:0px">Email :</label><span class="col-sm-8"  >'+res.data.hdr.email_id+'</span></div><div class=" row "><label for="name" class="col-sm-4" style="margin-bottom:0px"> Mobile : </label><span class="col-sm-8" >'+res.data.hdr.mob_no+'</span></div>';
  
                $('#shiptocust').val(res.data.hdr.customer_name)
               
                
               }
  
               if(res.data.lines_data.data[i][9]=='BILL_TO')
              {
                  
                  //alert(1)
                 // console.log(res.data.lines_data.data[i])
                 // alert(res.data.lines_data.data[i][12])
  
                  var $select = $('#customer_bill');
                  $select.html('');                     
                  $select.append("<option value="+res.data.lines_data.data[i][14]+">"+res.data.lines_data.data[i][12]+"</option>"); 
  
  
                //    var $select_1 = $('#number_bill');
                //    $select_1.empty();                     
                //    $select_1.append("<option value="+res.data.lines_data.data[i][11]+">"+res.data.lines_data.data[i][11]+"</option>"); 
                  
  
                 // document.getElementById('customer_bill').value=res.data.hdr_data.data[0][7] || '';
                //   document.getElementById('location_bill').value=res.data.lines_data.data[i][10] || '';                   
                //   document.getElementById('address_bill').value=res.data.lines_data.data[i][2] || '';                                     
                  //document.getElementById('address_2_bill').value=res.data.lines_data.data[i][3] || '';                   
                  //document.getElementById('address_3_bill').value=res.data.lines_data.data[i][4] || '';                   
                //   document.getElementById('area_bill').value=res.data.lines_data.data[i][6] || '';
                 
                 /// document.getElementById('country_bill').value=res.data.lines_data.data[i][8] || '';
                //   document.getElementById('contact_bill').value=res.data.lines_data.data[i][13] || '';
                  
                document.getElementById('bill_to_customer_infoo').innerHTML='<div class=" row" id="customer_infoo_tbl"> <label for="name" class="col-sm-4" >Name :</label><span class="col-sm-8"  >'+res.data.hdr.customer_name+'</span></div><div class=" row"><label class="col-sm-4"  for="name"> Customer #: </label><span  class="col-sm-8"   style="color: #007bff;text-decoration: none; background-color: transparent;cursor: pointer;" onclick="customer_history('+ res.data.hdr.account_number +')" >'+ res.data.hdr.account_number +'</span></div> <div class=" row "><label class="col-sm-4"  for="name">Email :</label><span class="col-sm-8"  >'+res.data.hdr.email_id+'</span></div><div class=" row "><label for="name" class="col-sm-4"> Mobile : </label><span class="col-sm-8" >'+res.data.hdr.mob_no+'</span></div>';
  
                $('#billtocust').val(res.data.hdr.customer_name)
  
               }
  
  
  
              
              // alert(123)
  
  
          }
  
         // document.getElementById('available_customer_address').innerHTML=out;
         // $('#available_customer_address').select2(); 
          //
         // alert(res.data.lines_data.data.length)
         // available_customer_address
       
         
      })
      .catch(function(){
          //$('#viewCust').unblock();
         // $('#v-form-detail').hide();
  
      })


}
</script>



<script>

function draft_addRow(tableID) {
            //alert(tableID)
			var table_cash = document.getElementById(tableID);
			var rowCount = table_cash.rows.length;			
			var row = table_cash.insertRow(rowCount);
			var colCount = table_cash.rows[0].cells.length;
			for(var i=0; i<colCount; i++) 
            {	
               // alert(rowCount)		

                //alert(table_cash.rows[i+1].cells[1].childNodes[0].value)

			// if(rowCount >= 3) 
			// {
			// 	table_cash.deleteRow(rowCount);
			// 	alert("Cannot add the rows more then 2.");
			// 	break;					
			// }

			//onkeyup="this.value = minmax(this.value,0, 1000000)"
				var newcell	= row.insertCell(i);
				newcell.innerHTML = table_cash.rows[1].cells[i].innerHTML;
				//alert(newcell.childNodes[0].type);
				switch(newcell.childNodes[0].type) {
					case "text":
							newcell.childNodes[0].value = "";
							newcell.childNodes[0].id="text"+rowCount;	
							newcell.childNodes[0].disabled=false;							
							break;
					case "checkbox":
							newcell.childNodes[0].checked = false;
							break;
					case "select-one":
							newcell.childNodes[0].selectedIndex =0;
						    newcell.childNodes[0].id='select'+i;	
							break;
					case "number":
							newcell.childNodes[0].value = "";
							newcell.childNodes[0].id="number"+rowCount;	
                            newcell.childNodes[0].class="sun_rec";	
							//newcell.childNodes[0].onkeyup = "this.value = minmax(this.value,0, 1000000)";
							break;
				}
			}
            draft_line_type_change();
            
		}


		
		function draft_selectval(id)
		{
		    		   
		    var sel=document.getElementById(id);
			var opt = sel.options[sel.selectedIndex];			 
					   
		   //alert(opt.text);
		   if(opt.text=="CASH")
		   {
		   document.getElementById("text"+id).disabled = true;
		   }
		   else
		   {
		   document.getElementById("text"+id).disabled = false;
		   } 
		   
		   
		   
		
		}
		
		function draft_deleteRow(tableID) {
			try {
			var table_cash = document.getElementById(tableID);
			var rowCount = table_cash.rows.length;
			for(var i=0; i<rowCount; i++) {
				var row = table_cash.rows[i];
				var chkbox = row.cells[0].childNodes[0];
				if(null != chkbox && true == chkbox.checked) {
					if(rowCount <= 1) 
					{
						alert("Cannot delete all the rows.");
						break;
					}
					table_cash.deleteRow(i);
					rowCount--;
					i--;
				}


			}
			}catch(e) 
			{
				
                alert(e);
			}
            draft_line_type_change()
		}

		function addRow(tableID) {
			var table = document.getElementById(tableID);
			var rowCount = table.rows.length;			
			var row = table.insertRow(rowCount);
            var colCount = table.rows[0].cells.length;
            var count=0;
            for(var i=0; i<colCount; i++) 
            {			

			// if(rowCount >= 2) 
			// {
			// 	table.deleteRow(rowCount);
			// 	alert("Cannot add the rows more then 2.");
			// 	break;					
			// }
			//onkeyup="this.value = minmax(this.value,0, 1000000)"
                var newcell	= row.insertCell(i);
                count++
               
                if(i==0)
                {
                   
                    newcell.innerHTML =rowCount;
                }
                else if(i==6)
                {
                    
                    newcell.innerHTML ='<a class="btn btn-xs delete-record"  v-bind:did="index+row.line_id"   onclick="deleteRow(this)">Delete</a>'
                }
                else
                {
                    
                    newcell.innerHTML = table.rows[1].cells[i].innerHTML;
                }
				
				//alert(newcell.childNodes[0].type);
				// switch(newcell.childNodes[0].type) {
				// 	// case "text":
				// 	// 		newcell.childNodes[0].value = "";
				// 	// 		newcell.childNodes[0].id="text"+rowCount;	
				// 	// 		newcell.childNodes[0].disabled=false;							
				// 	// 		break;					
				// 	// case "select-one":
				// 	// 		newcell.childNodes[0].selectedIndex = 1;
				// 	// 	    newcell.childNodes[0].id=rowCount;	
				// 	// 		break;
				// 	// case "number":
				// 	// 		newcell.childNodes[0].value = "";
				// 	// 		newcell.childNodes[0].id="number"+rowCount;	
				// 			//newcell.childNodes[0].onkeyup = "this.value = minmax(this.value,0, 1000000)";
				// 			break;
				// }
			}
		}


		
		function selectval(id)
		{
		    		   
		    var sel=document.getElementById(id);
			var opt = sel.options[sel.selectedIndex];			 
					   
		   //alert(opt.text);
		   if(opt.text=="CASH")
		   {
		   document.getElementById("text"+id).disabled = true;
		   }
		   else
		   {
		   document.getElementById("text"+id).disabled = false;
		   } 
		   
		   
		   
		
		}
		
		function deleteRow(thizz) {
            // try 
            // {

           
            line_to_removed=$(thizz).attr("did");

            $(thizz).closest('tr').remove();
           // $('#'+line_to_removed).remove();

			// var table = document.getElementById('pdi_line_act');
			// var rowCount = table.rows.length;
            // for(var i=0; i<rowCount; i++) 
            // {
			// 	var row = table.rows[i];
			// 	var chkbox = row.cells[0].childNodes[0];
			// 	if(null != chkbox && true == chkbox.checked) {
			// 		if(rowCount <= 1) 
			// 		{
			// 			alert("Cannot delete all the rows.");
			// 			break;
			// 		}
			// 		table.deleteRow(i);
			// 		rowCount--;
			// 		i--;
			// 	}


			// }
			// }catch(e) 
			// {
		 	// alert(e);
			// }
            }
            
shoppingCart.clearCart();           
      
      
$(document).on('click','.btn-item',function(event) {
    // if ($(this).index() == 0) return;
    var d = $(this).closest('table').DataTable().row($(this).closest('tr')).data();
    axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
    axios.defaults.xsrfCookieName = "csrftoken";
    axios.defaults.withCredentials = true;
    axios.post("/saleswores/get_reservation_det",d)
    .then(function(res){
        $('#reservation_detail').modal('show');
        $('#rdtl').empty().append(res.data[0]);
    })



})

 

$(document).on('click','.add-to-cart',function(event) {
    
    event.preventDefault();
    var dtApi = $(this).closest('table').DataTable();
    var rowData = $(this).closest('table').DataTable().row($(this).closest('tr')).data();
    console.log(rowData);
    var obj = {};
    Object.keys(rowData).forEach(function(key)
    {
        obj[key] = rowData[key];
    });
    /*
    Validatinig selected item's age
    */
    obj['current_org'] = JSON.parse(localStorage.getItem('defs')).organization_code;

    // obj['code'] = rowData.inventory_item_id + rowData.color.trim() + rowData.model_year.trim();
    rowData['serial_number'] = rowData['barcode'] + rowData['item_code'] + rowData['organization_code'];
    rowData['serial_number'] = rowData.organization_id;
    obj['name'] = rowData.inventory_item_id + rowData.organization_id;
    obj['name'] = obj['name'].trim();
    // $('#'+obj['name']).hide();
    obj['item_code'] = rowData.item_code;
    obj['organization_code'] = rowData.organization_code;
    obj['org_id'] = rowData.org_id;
    obj['organization_id'] = rowData.organization_id;
    obj['from_org_name'] = rowData.organization_name;
    // obj['serial_number'] = rowData.barcode+rowData.item_code+rowData.organization_code;
    obj['inventory_item_id'] = rowData.inventory_item_id;
    obj['onhand_qty'] = rowData.reservable_qty;
    obj['vin_price'] = rowData.vin_price;
    obj['inventory_item_enabled_flag'] = rowData.inventory_item_enabled_flag;
    obj['comment'] = "";
    obj['required_date'] = moment().add(0.5,'hours').format("DD-MMM-YYYY hh:mm:ss a").toUpperCase();

    // moment().format("DD-MMM-YYYY HH:mm:ss a").toUpperCase()
    var price = Number(0);


    flyToCart($(this).closest('tr')[0]);
    invTransfersCart.addItemToCart_invTransfersCart(obj, price, 1);
    dtApi.draw(false);
//   if(rowData.stock_status=='Available'){

//   } else {
//     alert('Stock status is not available');
//   }


  inv_trnfdisplayCart();
});


function inv_trnfdisplayCart() {
  var cartArray = invTransfersCart.listCart();
//   stepsCompnent.tab1.count = invTransfersCart.totalCount();
  $('.inv_transfer_qty_selected').html(invTransfersCart.totalCount());

  if (cartArray.length == 0){
    $('.show-cart').empty();
    $('.cart-tot').remove();
    $('.cart-zero').remove();
    $('.show-cart').after('<h4 class="cart-zero">Cart is empty.</h4>');
    $('.inv_transfer_qty_selected').html(invTransfersCart.totalCount());
    return;
  }

}
      
invTransfersCart.clearCart();

var glo_quotation_number = "{{quotation_number}}";

var glo_order_det;
$( document ).ready(function() 
{  
    console.log("ready!");   

    setTimeout(() => {get_order_type_lov()}, 1000);


    if (window.location.search.includes('order_number=')  && !window.location.search.includes('type=notasalesorder') ){
        glo_order_number = window.location.search.split('order_number=')[1];
        
        $('.pick_slip_options').show();
        ShowDIV();

        axios.get("{% url 'saleswores:getDraftOrderDet' %}?o="+glo_order_number)
        .then(function(res){

            glo_order_det = res.data;

            loadSalesOrder(glo_order_det);
            



        })
        .catch(function(err){
            // HideDIV();

        })
    } 
    
    else if (window.location.search.includes('order_number=') && window.location.search.includes('type=notasalesorder')) {

        
        // alert(glo_quotation_number);
        glo_quotation_number = window.location.search.split('order_number=')[1];
        $('#cust_quotations').append(`<option value="${glo_quotation_number}">${glo_quotation_number}</option>`).val(glo_quotation_number);
        axios.get("{% url 'saleswores:getQuotationDet' %}?q="+glo_quotation_number)
        .then(function(res){
            glo_order_det = res.data;

            loadSalesOrderFromQuotation(glo_order_det,true);
            



        })
        .catch(function(err){
            // HideDIV();

        })
        
    }
    
    else {
        $('.content-body').slideDown();
    }

});

$(document).on('select2:select','select',function(){
    $('.content-body').slideDown();
    // alert();
})


$(document).on('select2:select','select',function(){
    if (this.id == 'cust_quotations'){

        ShowDIV();
        axios.defaults.xsrfHeaderName = "X-CSRFTOKEN";
        axios.defaults.xsrfCookieName = "csrftoken";
        axios.defaults.withCredentials = true;
        axios.post("{%  url 'saleswores:getQuotationDet' %}?q="+this.value)
        .then(function(res){
            HideDIV()
            loadSalesOrderFromQuotation(res.data,false);
        })
        .catch(function(err){
            HideDIV();
            toastr.error("Error Loading Quotation ! ");

        })
    
    }
})


function loadSalesOrderFromQuotation(detail,canLoadCust){
            
    if (canLoadCust)
        select2_search($('#searchCust'),detail.cust_account_id);

    $("#customer_po").val(detail.lpo_number);
    $("#case_mark").val(detail.case_mark);
    $("#p_instructions").val(detail.packing_instruction);
    $("#order-status").val(detail.status);

    itemLinesEntry.lines_data = [];

    itemLinesEntry.lines_data = detail.lines;
    itemLinesEntry.lines_data.push({});
    itemLinesEntry.updateAmountsOnCustChange();


    itemLinesEntry.$nextTick(function(){
        $('#order_number').val("")
    });



}


function loadSalesOrder(detail){
            
    select2_search($('#searchCust'),detail.cust_account_id);

    $("#customer_po").val(detail.lpo_number);
    $("#case_mark").val(detail.case_mark);
    $("#p_instructions").val(detail.packing_instruction);
    $("#order-status").val(detail.status);

    itemLinesEntry.lines_data = [];

    itemLinesEntry.lines_data = detail.lines;
    itemLinesEntry.lines_data.push({});
    itemLinesEntry.updateAmountsOnCustChange();



}




function select2_search ($el, term) {
    ShowDIV();
  $el.select2('open');

  // Get the search box within the dropdown or the selection
  // Dropdown = single, Selection = multiple
  var $search = $el.data('select2').dropdown.$search || $el.data('select2').selection.$search;
  // This is undocumented and may change in the future

  $search.val(term);
  $search.trigger('input');

}




$(document).on('change', '#cash_collection select[name=country]' ,function(){
    // alert()
    if (this.value == 'CASH'){
        $(this).closest('tr').find('td:nth(3) input').val("")
    }
});

const itemsMapping = {}

function addInTable(item_code, quotation=false){
    console.log('addInTABLE addInTABLE addInTABLEaddInTABLE')
    var tr_html = ""
    var html = ""
    $('#showitemid').hide()
    if(jQuery.inArray(item_code, items) !== -1){
        $("#sp_products_item_code")[0].value = ""
    }else{
        $('#showitemid').hide()
        row_data = item_code.split("\t")
        console.log(row_data)
        if(row_data[1] && quotatio){
        }else{
            item=row_data[0]+'/1'
        }
        items.push(item)
        var NewArray = items.filter(function(element,index,self){
            return index === self.indexOf(element); 
        });

        console.log(NewArray);
        var data = $('#excel_data').val(NewArray);
        console.log(data)
        quantity = {}
        $.each(items, function(data_index, data_value) {
            items_array = data_value.split("/")
            quantity[items_array[0].replace(/\n/g,"")] = {
                'quantity': items_array[1]
            }
            
        });
        console.log("addInTABLE")
        axios.get("/saleswores/search_items?&items="+item_code)
        .then(function(res)
        {
            customer_vat = $('#customer_vat').val()
            var rowCount = $('#sp_product_id tr').length;
            $.each(quantity, function(index1, value1) {
                $.each(res.data.data, function(index, value) {
                    console.log('VALUEEEEEEEEEEEEEEE', value)
                    if($("#"+value.item_code).closest('tr').attr('id')){
                    }else{
                        itemsMapping[value.item_code] = value.inventory_item_id
                        if(index1 ==  value.item_code){
                            new_vat = "00.00"
                            if(customer_vat){
                                total = (value1.quantity * value.price).toFixedRound(2)
                                console.log(total)
                                vat_per = (customer_vat / 100)
                                console.log(vat_per)
                                new_vat = (total * vat_per).toFixedRound(2)
                                console.log(new_vat)  
                            }
                            
                            console.log(new_vat)
                            discount_val = "00.00"
                            if(value.discount != 0){
                                discount_p= value.discount
                                price = value.price
                                discount = (price * discount_p)
                                selling_price = price - discount
                                discount_val = (discount * value1.quantity).toFixedRound(2)
                            }else{
                                selling_price = value.price
                                discount_p = 0
                            }
                            console.log(new_vat)
                            total_li_price = (value1.quantity * selling_price)
                            console.log(Number(total_li_price) + Number(new_vat))
                            rowCount =  (rowCount + 1)
                            html += `<tr id=`+value.item_code+`>`
                            html += `<td><button class="delete-item btn btn-sm btn-danger" style="margin-right: 10px;" "+stylehide_btn_remove+"  data-name=`+value.item_code+`><i class="right fas fa-times"></i></button></td>`
                            html += `<td>`+rowCount+`</td>`
                            html += `<td>`+(value.barcode === null ? "":value.barcode )+`</td>`
                            html += `<td class="row_item_code">`+value.item_code+`</td>`
                            html += `<td>`+value.description+`</td>`
                            html += `<td>`+value.primary_unit_of_measure+`</td>`
                            html += '<td></td>' 
                            html += `<td> <input type="number" class="row_qty" oninput="event.target.value = event.target.value.replace(/[^0-9]*/g,'');" style="width:50%" id="quantity`+value.item_code+`" item_code="`+value.item_code+`" onblur="updateQuantity(this)" value="`+value1.quantity+`"></td>`
                            html += '<td id="list_price'+value.item_code+'">'+Number(value.price).toFixedRound(2)+'</td>'
                            html += `<td><input type="number" style="width:50%" id="price`+value.item_code+`" readonly disabled item_code="`+value.item_code+`" onblur="updatePrice(this)" value="`+Number(selling_price).toFixedRound(2)+`"></td>`
                            html += `<td><input type="number" style="width:50%" id="dis_val${value.item_code}" item_code="${value.item_code}" onblur="updateDiscount(this)" data-discount="${discount_p}" value="${Number(discount_val).toFixedRound(2)}"></td>`
                            {% comment %} html += '<td id="dis_val'+value.item_code+'"  data-discount="'+discount_p+'">'+Number(discount_val).toFixedRound(2)+'</td>' {% endcomment %}
                            html += '<td id="vat'+value.item_code+'">'+Number(new_vat).toFixedRound(2)+'</td>'
                            html += '<td id="total_price'+value.item_code+'">'+Number(Number(total_li_price) + Number(new_vat)).toFixedRound(2)+'</td>'
                            html += '<td><input type="hidden" id="total_exc_vat'+value.item_code+'" value="'+Number(selling_price).toFixedRound(2)+'" /></td>'
                            html += `</tr>`
                            $('#total_records').html(rowCount)
                        }
                        var delay = 2000;
                        setTimeout(function() {
                            getInvoiceTotal()
                        },delay)
                    }
                });
            })
            $('#sp_product_id').append(html)
        })
        .catch(function()
        {
        })
    }
    $("#sp_products_item_code")[0].value = ""
}

function updateQuantity(a){
    itemLinesEntry.needValidations= true;

    console.log('updateQuantity(a)');
    thizzzzzzzz=a;
    var inpQty=$(a).val();
    var req_item_code = thizzzzzzzz.getAttribute('item_code')
    var res_quantity = thizzzzzzzz.getAttribute('res_quantity')
    let inpDis=$('#dis_val'+req_item_code).val();

    var listPrice=parseFloat($("#list_price"+req_item_code).text());
    var line_gross = listPrice  * parseFloat(inpQty)
    $("#price"+req_item_code).val((line_gross).toFixedRound(2));
    $("#dis_perccc"+req_item_code).text(((inpDis/line_gross)*100).toFixedRound(2));   //LineDISCOUNT percentage

    
    res_quantity = $('#res_quantity'+req_item_code).html()
    discount_val = $('#dis_val'+req_item_code).attr("data-discount");
    if(res_quantity){
        if(res_quantity < inpQty){
            $('#quantity'+req_item_code).attr('max', res_quantity)
            {% comment %} $(a).val(res_quantity); {% endcomment %}
        }
    }
    price = parseFloat($('#list_price'+req_item_code).text())
    new_price = parseFloat(inpQty * price) - parseFloat(inpDis)
    $('#total_price'+req_item_code).html((new_price).toFixedRound(2))

    list_price = $('#list_price'+req_item_code).html()
    new_discount = ((list_price * inpQty)* discount_val)
    $('#dis_val'+req_item_code).html((new_discount).toFixedRound(2))

    customer_vat = $('#customer_vat').val()
    const dissss = parseFloat($('#dis_val'+req_item_code).val())
        if(customer_vat){
            total = ((inpQty * price)- dissss).toFixedRound(2)
            vat_per = (customer_vat / 100)
            new_vat = (total * vat_per).toFixedRound(2)
            $('#vat'+req_item_code).html(new_vat)
            total_price = $('#total_price'+req_item_code).html()
            add_new_vat = (parseFloat(total_price) + parseFloat(new_vat))
            $('#total_price'+req_item_code).html(add_new_vat)
            
        }
    
    data = $('#excel_data').val()
    console.log('4014 excel_data', data)
    tst = data.split(",")
    items_code = []
    $.each(tst, function(data_index1, data_value1) {
        items_array = data_value1.split("/")
        if(items_array[0].replace(/\n/g,"") == req_item_code){
            item=items_array[0]+'/'+inpQty
        }else{
            item=items_array[0]+'/'+items_array[1]
        }
        items_code.push(item)
    })
    items = items_code
    $('#excel_data').val(items_code)
    var delay = 1000;
        setTimeout(function() {
        getInvoiceTotal(items_code)
    },delay)
}


function updateDiscount(a){
    itemLinesEntry.needValidations= true;

    const _customer_vat = $('#customer_vat').val() || 0
    console.log('iNSISISISIS UPDATE DISCOUNT');
    const inpDis=parseFloat($(a).val());
    const req_item_code = a.getAttribute('item_code')
    const quan=parseFloat($("#quantity"+req_item_code).val());
    const listPrice=parseFloat($("#list_price"+req_item_code).text());
    const vat=parseFloat($("#vat"+req_item_code).text());
    const line_gross = (listPrice  * quan).toFixedRound(2)
    $('#dis_val'+req_item_code).attr("data-discount", inpDis);
    $('#dis_val'+req_item_code).attr("value", inpDis.toFixedRound(2));
    $("#price"+req_item_code).val(line_gross);   //GROSS WITHOUT DISCOUNT
    $("#dis_perccc"+req_item_code).text(((inpDis/line_gross)*100).toFixedRound(2));   //LineDISCOUNT percentage
    const total_exc_vat = ((listPrice  * quan) - inpDis)
    console.log('total_exc_vat', total_exc_vat)
    $("#total_exc_vat"+req_item_code).val(total_exc_vat);  //GROSS WITH DISCOUNT WITHOUT VAT
    const new_vat = parseFloat(total_exc_vat)*(parseFloat(_customer_vat)/100)
    $("#vat"+req_item_code).text(new_vat.toFixedRound(2))
    $('#total_price'+req_item_code).text((parseFloat(total_exc_vat) + parseFloat(new_vat)).toFixedRound(2));  //LINE TOTAL
    getInvoiceTotal()
}


function updatePrice(a){
    itemLinesEntry.needValidations= true;

    var req_item_code = a.getAttribute('item_code')
    var eee = 'Selling price of the item in line number is less then list price  ';
    // line_popover_error(req_item_code,eee);
    // $('.'+req_item_code).html('&#9432;'); 
    //         $('.'+req_item_code).css("background-color", "red");
    //         $('.'+req_item_code).css("display", "initial");
    var inpQty=$('#quantity'+req_item_code).val();
    let inpDis=$('#dis_val'+req_item_code).val();
    price = $('#price'+req_item_code).val()
    new_price = parseFloat(inpQty * price) - parseFloat(inpDis)
    var delay = 1000;
        customer_vat = $('#customer_vat').val();
    setTimeout(function() {
    if(customer_vat){
        quantity = $('#quantity'+req_item_code).val();
        price = parseFloat($('#list_price'+req_item_code).text())
        total = (quantity * price).toFixedRound(2)
        vat_per = (customer_vat / 100)
        new_vat = (total * vat_per).toFixedRound(2)  
    }
    newPrice = parseFloat(new_price) + parseFloat(new_vat)

    console.log("newPrice",newPrice)
    $('#vat'+req_item_code).html(new_vat)
    $('#total_price'+req_item_code).html((newPrice).toFixedRound(2))
    getInvoiceTotal()
    },delay)
}

function updateVat(vat){
    itemLinesEntry.needValidations= true;

    items_code = []
    var pastedData = $('#excel_data').val();
    var data = pastedData.split("\t")
    $.each(data, function(index, value) {
        item = value.split(",")
        $.each(item, function(index1, value1) {
            var data1 = value1.split("/")
            items_code.push(data1[0].replace(/\n/g,""))
        });
    });
    customer_vat = $('#customer_vat').val()
    $.each(items_code, function(index1, value1) {
        new_vat = "00.00"
        if(customer_vat){
            quantity = $('#quantity'+value1).val()
            price = parseFloat($('#list_price'+value1).text())
            total = (quantity * price).toFixedRound(2)
            vat_per = (customer_vat / 100)
            new_vat = (total * vat_per).toFixedRound(2)  
        }
        line_total = $('#total_price'+value1).html()
        $('#vat'+value1).html(new_vat)
        to_pr = parseFloat(line_total) + parseFloat(new_vat)
        $('#total_price'+value1).html((to_pr).toFixedRound(2))

    })
    getInvoiceTotal()
}



function getInvoiceTotal(){
    itemLinesEntry.needValidations= true;

    total_line_price = 0
    total_line_vat = 0
    let total_discount = 0
    let grand_line_total_only_items = 0;
    $('#sp_product_id tr').each(function(i){   
        // console.log(10 , 'line discount', $(this).find('td')[10]);         
        // console.log(11, $(this).find('td')[11]);         
        // console.log(12, $(this).find('td')[12]);  
        let line_discount= parseInt($($(this).find('td')[10]).find('input').val())
        let line_gross= parseInt($($(this).find('td')[9]).find('input').val()) //WITHOUT DISCOUNT AND VAT 
        grand_line_total_only_items += line_gross;
        console.log('line 4098', line_discount);
        total_discount += parseInt(line_discount)
        console.log('line 4100', total_discount);
        if($($(this).find('td')[12]).text()){
            let line_vat = $($(this).find('td')[12]).text()
            console.log('4129', line_vat);
            line_vat = parseFloat(line_vat)
            console.log('4103', line_vat);
            total_line_vat += parseFloat(line_vat)
            console.log('4105', total_line_vat);
        }
        if($($(this).find('td')[13]).text()){
            price = $($(this).find('td')[13]).text()
            console.log('4109', price);
            // total_line_price += (parseFloat(price) - line_discount)
            total_line_price += parseFloat(price) //LINE TOTAL HAS THE UPDATED VALUE WITH THE DISCOUNT
            console.log('4111', total_line_price);
        }
        console.log('total_line_price', total_line_price);
        console.log('total_line_vat', total_line_vat);
        console.log('total_discount', total_discount);
        $('#total_disc_srsum').html((total_discount).toFixedRound(2))
        $('#grand_line_total').html((total_line_price).toFixedRound(2))
        $('#grand_val').html((total_line_vat).toFixedRound(2))
        $('#grand_total').html((total_line_price).toFixedRound(2))
        $('#grand_val2').html((total_line_vat).toFixedRound(2))
        $('#grand_line_total2').html((total_line_price).toFixedRound(2))
        $('#grand_line_total_only_items').html((grand_line_total_only_items).toFixedRound(2))
        
        console.log( 'LALALALALALAOMEDCIOIUCWUI', $('#total_disc_srsum').html())

        $('#gross_amount_sum').html((grand_line_total_only_items).toFixedRound(2))
        $('#discount_amount_sum').html((total_discount).toFixedRound(2))   //
        $('#total_discount_percentage').html(((total_discount/ grand_line_total_only_items)*100).toFixedRound(2) + '%')  // (Discount Amount / Original Price) x 100

        // console.log(total_line_price)
        
    });         
}

function updateNo(){
    $('#sp_product_id tr').each(function(i){            
        $($(this).find('td')[1]).html(i+1);          
    }); 
}

function removeNotFound(){
    // $('#sp_product_id tr').each(function(i){            
    //     if($($(this).find('td')[2]).html()){
    //         console.log("in if")
    //     }else{
    //         name = $($(this).find('td')[3]).html()
    //         console.log(name)
    //         var NewArray = items.filter(function(element,index,self){
    //             return index === self.indexOf(element); 
    //         });
    //         console.log(NewArray)
    //         $.each(NewArray, function(index, value){
    //           rowdata = value.split("/")
    //           const vala = rowdata[0].replace(/(?:\\[rn])+/g, "")
    //           if($.trim(vala) == name){
    //             items.splice(index,1)
    //           }
    //         })
    //         console.log(items)
    //         $('#excel_data').val(items)
    //         console.log($('#excel_data').val())
    //         tr = $("#"+name).remove()
    //     shoppingCart.removeItemFromCartAll({'name':name});
    //     var rowCount = $('#sp_product_id tr').length;
    //     $('#total_records').html(rowCount)
    //     updateNo()
    //     }
        
    // });


    $('#sp_products tbody tr td:contains("Not found")').closest('tr').remove();
    var rowCount = $('#sp_product_id tr').length;
    $('#total_records').html(rowCount);
    updateNo();
}

function inventorytransfer(){
    var val = [];
        $(':checkbox:checked').each(function(i){
          val[i] = $(this).val();
        });
    alert(val)
}

     
</script>













<script>

var gloPastingFlag =false;
function initACItems(e){

    $(e).autocomplete({
            clearButton: true,
            source: function(request, response) {
                // alert(window.gloPastingFlag);
                
                // alert();
                $( this.element[0] ).autocomplete( "option", "appendTo",  this.element[0].nodeName == 'INPUT'? $(this.element[0]).closest('div'): $(this.element[0]).closest('table'));
                var name = this.element[0].name === undefined ? this.element[0].dataset.field_name:this.element[0].name;

                   
                $.getJSON("/saleswores/search_items?order_type_id="+$('#order_type_lov_item_page').val()+"&q="+request.term.toUpperCase(), {
                    autocomplete: true,
                }, response);

            },
            minLength: 1,
            select: function( event, ui ) {
                event.preventDefault();
                var display =  ui.item.item_code === undefined ? '':ui.item.item_code;


                console.log(ui.item);
                console.log(event);

                    var line = ui.item;
                    var position = $(event.target).closest('tr').index()+1;

                    var lastElementPosition = itemLinesEntry.lines_data.length-1;

                    console.log($(event).closest('tr'));
                    console.log(position);
                    console.log('^p');
                    console.log(itemLinesEntry.lines_data.length);
                
                    

                    var obj = itemLinesEntry.getEmptyLineObj();
                    obj["vat"] = parseFloat(itemLinesEntry.customer_vat_perc) * parseFloat(line['price']);
                    obj["discount_perc"] =  0.0;
                    obj["discount"] =  line['discount'] || 0.0;
                    obj["qty"] =  line['quantity'] || 1;
                    obj["gross_amount"] =  parseFloat(obj["qty"]) * parseFloat(line['price']);
                    obj["line_total"] =  obj["gross_amount"] - parseFloat(obj["discount"]) + obj["vat"] 
                    obj["unit_price"] =  line['price'];
                    obj["avl_qty"] =  "";
                    obj["uom"] =  line['primary_unit_of_measure'];
                    obj["item_desc"] =  line['description'];
                    obj["item_code"] =  line['item_code'];
                    obj["inventory_item_enabled_flag"] =  line['inventory_item_enabled_flag'];
                    obj["inventory_item_id"] =  line['inventory_item_id'];

                    obj["unit_selling_price"] = line['price'];
                    // obj["unit_selling_price"] = (parseFloat(obj["gross_amount"] ) - parseFloat(obj["discount"]))/parseFloat(obj["qty"])


                    obj["barcode"] =  "";
                    obj["no_#"] =  $(event).closest('tr').index()+1;
                    obj["action"] =  "";
                    obj["line_error"] =  null;
                    obj["category"] = line['category'];
                    obj["related_flag"] = 'N';


                    var itemExists = itemLinesEntry.lines_data.filter((x,i)=> i !=  itemLinesEntry.lines_data.length-1 ).map(x=>x.item_code).includes(line['item_code'] );

                    if (itemExists && itemLinesEntry.lines_data.length != 1){
                        return toastr.error("Item already exists");
                    }

                    //existing line
                    if (position != itemLinesEntry.lines_data.length){

                        itemLinesEntry.lines_data[position] = obj;

                    }
                    // input line
                    if (position == itemLinesEntry.lines_data.length){

                        itemLinesEntry.lines_data.splice(lastElementPosition,0,obj);

                        itemLinesEntry.lines_data[itemLinesEntry.lines_data.length-1] = {};

                        // alert('input line')
                    }



             

                                            
                                            
            },
        }).focus(function() {
            $(e).autocomplete("search", $(e).val());
    }).autocomplete( "instance" )._renderItem = function( ul, item ) {
        if (gloPastingFlag) return $( "<li>" );
        console.log(item);
        // <b> Barcode :</b> ${item.barcode}<br>
        return $( "<li>" )
            .append(
                    `<div >
                        <b> Item Code : </b> ${item.item_code}<br>
                        <b> Description : </b> ${item.description}<br>
                    </div>`
            // "<div>" + (item.field_display_desc === undefined ? '':item.field_display_desc) +"&nbsp;&nbsp;&nbsp;"+ item.field_display_value + "</div>" 
            )
            .appendTo( ul )   ;
    };
}



//     $(document).on('input','td[contenteditable]',function(event) {

//             var self = this;

//             // skip for arrow keys

//             if(event.which >= 37 && event.which <= 40) return;

        

//             // format number




//         typewatch(() => {
//             if ($(self).data('column') != 'item_code'){
//                 $(self).text(function(index, value) {
//                     // return addCommas(value.split(",").join("")).replace(".00","");
//                 });
//             }
//             placeCaretAtEnd(event.target);
//         }, 1000);
//         placeCaretAtEnd(event.target);
// });

function placeCaretAtEnd(el) {
    el.focus();
    if (typeof window.getSelection != "undefined" && typeof document.createRange != "undefined") {
        var range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(false);
        var sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
    } else if (typeof document.body.createTextRange != "undefined") {
        var textRange = document.body.createTextRange();
        textRange.moveToElementText(el);
        textRange.collapse(false);
        textRange.select();
    }
}

var typewatch = function(){
    var timer = 0;
    return function(callback, ms){
        clearTimeout (timer);
        timer = setTimeout(callback, ms);
    }  
}();  




function addCommas(x,minimumFractionDigits) {
        if (typeof(x) == 'undefined') x='0';
        if ((x).toString().trim() == "")
            return "";
        if (isNaN(x.toString().split(',').join(""))) return "";
        var number = new Number(parseFloat(x.toString().split(',').join("")).toFixedRound(2)).toLocaleString('en-US', {minimumFractionDigits: minimumFractionDigits});
        return number;
}

var itemLinesEntry = new Vue({
    'el':'#entry-new',
    delimiters:['[[',']]'],
    data:function(){
        return {
            'fromQuotation':false,
            'showPreview':false,
            "editable_fields":['item_code','qty','unit_selling_price'],
            "comma_seperated_fields":['unit_price','gross_amount','discount','discount_perc', 'line_total', 'vat','unit_selling_price'],
            "comma_seperated_fields_int":['qty','avl_qty'],
            "disc_excluded":['SPI'],
            "columns":[
                {
                    "data":"action",
                    "title":"",
                    "visible":true,
                    "col_class":"text-left",
                    "placeholder":"",
                    "hasAggregation":false,
                    "aggregate": "",
                    "aggregateValue":""
                },
                {
                    "data":"no_#",
                    "title":"No #",
                    "visible":true,
                    "col_class":"text-left",
                    "placeholder":"",
                    "hasAggregation":false,
                    "aggregate": "",
                    "aggregateValue":""
                },
                {
                    "data":"barcode",
                    "title":"Barcode",
                    "visible":false,
                    "col_class":"text-left",
                    "placeholder":"",
                    "hasAggregation":false,
                    "aggregate": "",
                    "aggregateValue":""
                },
                {
                    "data":"item_code",
                    "title":"Item Code",
                    "visible":true,
                    "col_class":"text-left",
                    "placeholder":"Enter the Item Code",
                    "hasAggregation":false,
                    "aggregate": "",
                    "aggregateValue":""
                },
                {
                    "data":"item_desc",
                    "title":"Item Desc",
                    "visible":true,
                    "col_class":"text-left",
                    "placeholder":"",
                    
                    "hasAggregation":false,
                    "aggregate": "",
                    "aggregateValue":""
                },
                {
                    "data":"uom",
                    "title":"UOM",
                    "visible":true,
                    "col_class":"text-left",
                    "placeholder":"",
                    "hasAggregation":false,
                    "aggregate": "",
                    "aggregateValue":""
                },
                {
                    "data":"unit_price",
                    "title":"List Price",
                    "visible":true,
                    "col_class":"text-right",
                    "placeholder":"",
                    "hasAggregation":false,
                    "aggregate": "",
                    "aggregateValue":""
                },
                {
                    "data":"avl_qty",
                    "title":"Avl Qty",
                    "visible":true,
                    "col_class":"text-center",
                    "placeholder":"",
                    "hasAggregation":false,
                    "aggregate": "",
                    "aggregateValue":""
                },
                {
                    "data":"qty",
                    "title":"Ord Qty",
                    "visible":true,
                    "col_class":"text-center",
                    "placeholder":"",
                    "hasAggregation":false,
                    "aggregate": "",
                    "aggregateValue":""
                },
                {
                    "data":"unit_selling_price",
                    "title":"Unit SP",
                    "visible":true,
                    "col_class":"text-right",
                    "placeholder":"",
                    "hasAggregation":false,
                    "aggregate": "",
                },
                {
                    "data":"gross_amount",
                    "title":"Total SP",
                    // "title":"Line Total (Excl VAT)",
                    "visible":true,
                    "col_class":"text-right",
                    "placeholder":"",
                    "hasAggregation":true,
                    "aggregate": "sum",
                },
                {
                    "data":"discount",
                    // "title":"Discount <br>/ Surcharge",
                    "title":"Discount",
                    "visible":true,
                    "col_class":"text-right",
                    "placeholder":"",
                    "hasAggregation":true,
                    "aggregate": "sum",
                },
                {
                    "data":"discount_perc",
                    "title":"Disc %",
                    // "title":"Discount %",
                    "visible":true,
                    "col_class":"text-right",
                    "placeholder":"",
                    "hasAggregation":true,
                    "aggregate": "total_perc_discount",
                },
                {
                    "data":"vat",
                    "title":"VAT Amt",
                    "visible":true,
                    "col_class":"text-right",
                    "placeholder":"",
                    "hasAggregation":true,
                    "aggregate": "sum",
                },
                {
                    "data":"line_total",
                    // "title":"Total",
                    "title":"Net SP",
                    "visible":true,
                    "col_class":"text-right",
                    "placeholder":"",
                    "hasAggregation":true,
                    "aggregate": "sum",
                },
            ],
            "lines_data":[
                {}
            ],
            "customer_vat_perc": 0,
            'needValidations': true,
            'header_error': {},
            'column_aggregates': {
                gross_amount: 0, 
                discount: 0, 
                discount_perc: 0, 
                vat: 0, 
                line_total: 0,
            },
            'column_aggregates_labels': {
                gross_amount: "Lines Total (Excl VAT)", 
                // discount: "Total Adjustments", 
                // discount_perc: "Total Discount Perc", 
                vat: "VAT", 
                line_total: "Total",
            }
        }
    },
    methods:{
        parseFloatRound(number){
            return parseFloat(parseFloat(Number(number).toFixedRound(6)).toFixedRound(2))
        },
        getLinesDataForPreview(){
            return this.lines_data.filter(x=>parseFloat(x.avl_qty) > 0 || x.inventory_item_enabled_flag == 'N').filter(x=>parseFloat(x.unit_price) > 0 || x.inventory_item_enabled_flag == 'N');
        },
        sanitizeNumber(num){
            console.log('insanitizeNumber(num)', num)
            return parseFloat(num.toString().replace(',', '').split('-').join(""))
        },
        updateAmountsOnCustChange(){
            itemLinesEntry.lines_data.slice(0,itemLinesEntry.lines_data.length-1).forEach(obj=> itemLinesEntry.onInputLineUSP(obj,obj.unit_selling_price));
        },
        
        updateGrossPriceForTable(){
            itemLinesEntry.needValidations= true;
            const self = this;
            if (self.lines_data.length > 1){
                self.lines_data.filter((x,i)=> i!= self.lines_data.length-1).forEach((line,i)=>{
                    if (line.unit_selling_price > 0){

                        line.gross_amount = line.qty * line.unit_selling_price;


                        if (!line.discount){
                            line.discount = 0
                            line.discount_perc = 0
                        }

                        

                        line.vat = line.gross_amount * self.customer_vat_perc

                        // line.line_total = total_without_vat + line.vat;
                    }

                    this.$set(self.lines_data,i,line);

                });

            }

            console.log('updateGrossPriceForTable', self.lines_data)
        },
        refreshTotals(){
            var self =this;
            this.columns.forEach(col=>{
                self.applyAggregate(col);
            });

        },
        removeTr(obj,trIndex){
            if (this.lines_data.length > 1)
                this.lines_data.splice(this.lines_data.indexOf(obj),1);
        },
        applyAggregate(col, returnWithoutCommas=false){
            var colKey = col.data;
            var sum = 0;
            var self=this;
            if (col.aggregate == 'sum'){
                if (colKey == 'gross_amount'){
                    var dataa = this.lines_data.filter(x=> typeof(x.unit_price) !== 'undefined' && typeof(x.qty) !== 'undefined' ).filter(x=>x.unit_price!="" && x.qty!='' );
                    // debugger;
                    dataa.forEach(li=>{
                        sum += parseFloat(li.unit_selling_price) * parseFloat(li.qty)
                    })
                }
                else{
                    sum = self.lines_data.filter((x,i)=>i != self.lines_data.length-1).map(x=>x[colKey]).filter(x=> typeof(x) !== 'undefined' ).filter(x=>x!="").reduce((a,b)=> self.parseFloatRound(a) + self.parseFloatRound(b),0);
                }

                if (colKey == 'gross_amount'){
                    this.column_aggregates.gross_amount = sum;
                }
                if (colKey == 'vat'){
                    this.column_aggregates.vat = parseFloat(sum.toFixedRound(6)).toFixedRound(2);
                    sum = parseFloat(sum.toFixedRound(6)).toFixedRound(2);
                }
                if (colKey == 'line_total'){
                    this.column_aggregates.line_total =  parseFloat(sum.toFixedRound(6)).toFixedRound(2);
                    sum = parseFloat(sum.toFixedRound(6)).toFixedRound(2);

                }
            }
            if (col.aggregate == 'total_perc_discount'){
                var gross_total = 0;
                // this.lines_data.filter((x,i)=> i != this.lines_data.length-1).filter(x=> !this.disc_excluded.includes(x.category)).forEach(function(x){
                this.lines_data.filter((x,i)=> i != this.lines_data.length-1).forEach(function(x){
                    gross_total += (x.unit_price * x.qty)
                })
                var sp_total = 0;
                // this.lines_data.filter((x,i)=> i != this.lines_data.length-1).filter(x=> !this.disc_excluded.includes(x.category)).forEach(function(x){
                this.lines_data.filter((x,i)=> i != this.lines_data.length-1).forEach(function(x){
                    sp_total += (x.unit_selling_price * x.qty)
                })

                sum = (gross_total - sp_total)* 100 / gross_total   ;
            }
           
            if (this.comma_seperated_fields.includes(col.data)){
                sum = addCommas(sum,2);
            }
            else if (this.comma_seperated_fields_int.includes(col.data)){
                sum = addCommas(sum,0);
            }
            return sum;
        },
        
        applyDiscount(){
            var self = this;
            var discount_perc = parseFloat($('#cust_discount').val()||0 ) / 100;
            

            self.lines_data.filter((x,i)=> i != self.lines_data.length-1).forEach(line=>{
                if (!self.disc_excluded.includes(line.category)){
                    line.unit_selling_price =  parseFloat(line.unit_price- (line.unit_price *     discount_perc)).toFixedRound(6);
                    line.unit_selling_price = parseFloat(parseFloat(line.unit_selling_price).toFixedRound(2));

                }
            })

            self.$nextTick(function(){
                self.updateAmountsOnCustChange();
            })

        },
        applyListPrice(){
            var self = this;

            self.lines_data.filter((x,i)=> i != self.lines_data.length-1).forEach(line=>{
                if (!self.disc_excluded.includes(line.category)){
                    line.unit_selling_price =  parseFloat(line.unit_price).toFixedRound(6);
                    line.unit_selling_price = parseFloat(parseFloat(line.unit_selling_price).toFixedRound(2));

                }
            })

            self.$nextTick(function(){
                self.updateAmountsOnCustChange();
            })

        },
        removeNotFound(){
            var self = this;
            self.lines_data = self.lines_data.filter(x=>x.item_desc ).filter(x=> parseFloat(x.unit_price) != 0).filter(x=>parseFloat(x.avl_qty) != 0 ).filter(x=>x.inventory_item_enabled_flag != 'E').concat(
                self.lines_data.filter(x=>x.inventory_item_enabled_flag == 'N')
            ).concat({})
        },
        getStockForItems(){
            
            if (this.lines_data.length-1 >500){
                return toastr.error("Max allowed items is 500 ! Please remove additional item to proceed. ");
            }

            var self=this;
            var items_str = self.lines_data.filter((x,i)=> i!= self.lines_data.length-1).filter(x=>Object.keys(x).includes('item_code')).map(x=> x.item_code +'~'+x.qty).join(",");
            if (items_str == ''){
                toastr.error("Please add atleast one item code")
                return
            }
            ShowDIV(['Getting stock details...']);

            axios.get("/sales/filtered_stock2?o="+$('#order_number').val()+"&defs=" + localStorage.getItem("defs") + "&inventory_item_id=" +encodeURIComponent(items_str))
            .then(function (res) {
                HideDIV();
                response= res.data.data;
                response.forEach(item=>{
                    self.lines_data.filter(x=>x.item_code == item.item_code)[0]['avl_qty'] = item['reservable_qty'] ;
                    self.lines_data.filter(x=>x.item_code == item.item_code)[0]['unit_price'] = item['sale_price'] ;
                    self.lines_data.filter(x=>x.item_code == item.item_code)[0]['related_flag'] = item['related_flag'] ;
                });
                
                itemLinesEntry.updateAmountsOnCustChange();

            })
            .catch(function (err) {
                HideDIV();
            })

        },
        afterRender(){
            var self = this;
            this.$nextTick(function(){
                self.initAutoComplete();
            })
        },
        initAutoComplete(){
            var tds = $('tbody td[data-column="item_code"]');

            tds.each(function(){
                initACItems(this);
            })                
        },
        generateTdClass(col,obj,trIndex){
            if (['unit_price','avl_qty'].includes(col.data)  && trIndex != this.lines_data.length-1){
                if (parseFloat(obj[col.data] ) == 0 && obj.inventory_item_enabled_flag =='N' ) {
                    return "  font-weight-bold ";

                }
                if (parseFloat(obj[col.data] ) == 0 ) {
                    return " text-danger font-weight-bold ";

                }
                else {
                    if (col.data == 'avl_qty' && parseFloat(obj.qty ||0) >parseFloat(obj.avl_qty ||0) ){
                        return " text-danger font-weight-bold ";
                    }
                    if (col.data == 'avl_qty' ){
                        return " text-success font-weight-bold ";
                    }

                }
                return "";
            }
            if (['item_code'].includes(col.data)  && trIndex != this.lines_data.length-1){
                return "";
            }
            if (['qty','unit_selling_price'].includes(col.data)  && trIndex == this.lines_data.length-1){
                return "";
            }

            if (col.data == 'unit_selling_price' && this.disc_excluded.includes(obj.category) ){
                return " editable-td text-primary font-weight-bold ";
            }

            return (this.editable_fields.includes(col.data) && !this.showPreview ? ' editable-td ': '');
        },
        canbeEditable(col,obj,trIndex){

            // if (col.data == 'unit_selling_price' && this.disc_excluded.includes(obj.category) ){
            //     return false;
            // }

            if (col.data == 'item_code' && trIndex != this.lines_data.length-1){
                return false;
            }
            if (col.data == 'item_code'){
                return true;
            }
            if (trIndex == this.lines_data.length-1 ) {
                return false;
            } else {
                return true;
            }
        },
        getTDContent(col,obj,trIndex){

            var tdContent = obj[col.data];
            if ( !this.editable_fields.includes(col.data) ){
                if (this.comma_seperated_fields.includes(col.data)){
                    tdContent = addCommas(tdContent,2);
                }
                if (this.comma_seperated_fields_int.includes(col.data)){
                    tdContent = addCommas(tdContent,0);
                }
            }

            if (trIndex == this.lines_data.length-1) {
                return "";
            }

            return tdContent;
        },
        customerVatChange(){
            itemLinesEntry.needValidations= true;
            const self = this;
            if (self.lines_data.length > 1){
                self.lines_data.forEach(line => {
                    const amt_wo_vat = line.gross_amount - line.discount
                    line.vat = amt_wo_vat * self.customer_vat_perc
                    line.line_total = amt_wo_vat + line.vat
                })
            }
        },
        onInputLineUSP(obj, newValue){
            itemLinesEntry.needValidations= true;
            var self = this;
            // console.log('onInputLineUSP(){', newValue, obj.unit_price, self);

            obj.unit_selling_price = newValue || 0;
            
            if (self.fromQuotation==false && parseFloat(newValue) >  parseFloat(obj.unit_price)){
                obj.unit_selling_price = parseFloat(obj.unit_price);
            }
            if (self.fromQuotation==true){
                if (obj.sourcing=='Available' && (parseFloat(obj.unit_selling_price) >  parseFloat(obj.unit_price))){
                    toastr.error('Unit selling price should not greater than unit price for available souce')
                    obj.unit_selling_price = parseFloat(obj.unit_price);
                }
            }


            obj['sp_gross'] = parseFloat(obj.qty) * parseFloat(obj.unit_selling_price);
            
            
            obj.gross_amount = parseFloat(obj.qty) * parseFloat(obj.unit_selling_price);

            obj.discount = (parseFloat(obj.unit_price) - parseFloat(obj.unit_selling_price)    ) * parseFloat(obj.qty);


            obj.line_total = parseFloat(obj.gross_amount) - parseFloat(obj.discount);

            if ( (parseFloat(obj.unit_price) - parseFloat(obj.unit_selling_price))  >  0) {
                // debugger;
                obj.discount_perc =  ((
                        (parseFloat(obj.unit_price) - parseFloat(obj.unit_selling_price))
                        /parseFloat(obj.unit_price) 
                    ) *100)    || 0;
            } else {
                obj.discount_perc = 0;
            }



            // obj.discount = obj.discount < 0 ? 0 : -1 * obj.discount;
            obj.discount = -1 * obj.discount;

            obj.discount_perc = obj.discount_perc < 0 ? -1 * obj.discount_perc : obj.discount_perc;

            obj.vat = parseFloat(obj.sp_gross) * this.customer_vat_perc ;
            
            obj.line_total = obj.vat + parseFloat(obj.sp_gross) ;

            // setTimeout(function(){
            //     self.updateAmountsOnCustChange();
            // },250)
            
            
            this.setCollectionAmountForCA();
        },
        setCollectionAmountForCA(){
            $("#number0").val( parseFloat(itemLinesEntry.column_aggregates['line_total']).toFixedRound(2) );

            $('#rem_amount_').text('0.00');

        },
        // onInputLineDiscount(obj, newValue){
        //     itemLinesEntry.needValidations= true;
        //     var self = this;
        //     console.log('onInputLineDiscount(){', newValue, obj.unit_price, self);

        //     obj.discount = newValue || 0
        //     obj.discount_perc = (parseFloat(obj.discount)/parseFloat(obj.gross_amount))*100 || 0
        //     const total_without_vat = parseFloat(obj.gross_amount) - parseFloat(obj.discount);
        //     obj.vat = parseFloat(total_without_vat * self.customer_vat_perc)
        //     obj.line_total = total_without_vat + obj.vat;
        //     obj.unit_selling_price = (parseFloat(obj.gross_amount) - parseFloat(obj.discount))/parseFloat(obj.qty);
        // },
        onInputLineQty(obj, newValue){
            itemLinesEntry.needValidations= true;
            var self = this;
            obj.qty = newValue||1;

            if (obj.avl_qty != ""){
                if (parseFloat(obj.qty) > parseFloat(obj.avl_qty) && obj.inventory_item_enabled_flag != 'N'){
                    obj.qty = 1;
                }
            }
            obj.qty = parseFloat(newValue) < 0 ? 1 :newValue;


            // console.log('onInputLineQty(obj, newValue){', obj.qty, obj.unit_price);
            obj.gross_amount = obj.qty * parseFloat(obj.unit_price);
            obj.discount = (parseFloat(obj.unit_price) - parseFloat(obj.unit_selling_price)    ) * parseFloat(obj.qty);


            // obj.discount_perc = (parseFloat(obj.discount)/parseFloat(obj.gross_amount))*100 || 0;

            // obj.discount_perc = obj.discount_perc < 0 ? 0 :obj.discount_perc;


            const total_without_vat = parseFloat(obj.gross_amount) - parseFloat(obj.discount);
            obj.vat = parseFloat(total_without_vat * self.customer_vat_perc)
            obj.line_total = total_without_vat + obj.vat;

            // obj.unit_selling_price = (parseFloat(obj.gross_amount) - parseFloat(obj.discount))/parseFloat(obj.qty)

            // obj.unit_selling_price = parseFloat(obj.unit_selling_price.toFixedRound(2));
            setTimeout(function(){
                self.updateAmountsOnCustChange();
            },250)

            

            this.setCollectionAmountForCA();
        },
        lineOnChange(col,obj,$event){
            obj[col.data] = $event.target.innerHTML;
            itemLinesEntry.needValidations= true;
            var self = this;
            this.$nextTick(function(){
                placeCaretAtEnd($event.target);
            })
            let newValue = $event.target.innerText;
            if (col.data == 'item_code'){
                obj.item_code = $event.target.innerText;
            }
            if (col.data == 'qty'){
                self.onInputLineQty(obj, self.sanitizeNumber(newValue))
            }
            if (col.data == 'unit_selling_price'){
                self.onInputLineUSP(obj, self.sanitizeNumber(newValue))
            }
            // else if (col.data == 'discount'){
            //     self.onInputLineDiscount(obj, self.sanitizeNumber(newValue)) 
            // }
            // else if (col.data == 'item_code'){
            //     if (newValue == "")
            //         obj = this.getEmptyLineObj();
            // }
        },

        getEmptyLineObj(){
            return this.columns.reduce((a,b)=> Object.assign({[b.data]:""} ,a) ,{});
        },
        addToLines(lines,offset){
            var self = this;
            console.log(self);
            // self.lines_data = self.lines_data.slice(0,offset);
            // if (self.lines_data.length == 1){
                // }
            // self.lines_data =[];

            self.lines_data  = self.lines_data.slice(0,-1);
            lines.forEach((line,i)=>{
                var obj = self.getEmptyLineObj();
                if (self.lines_data.map(x=>x.item_code).includes(line.item_code))
                    return toastr.error(`Duplicate Item ${line.item_code} not allowed. Moving to next item`);

                obj["qty"] =  line['quantity'] || 1;
                obj["vat"] = parseFloat(self.customer_vat_perc) * parseFloat(line['price']);
                obj["discount_perc"] =  0.0;
                obj["discount"] =  line['discount'] || 0.0;
                obj["gross_amount"] =  parseFloat(line['quantity']) * parseFloat(line['price']);
                obj["line_total"] =  obj["gross_amount"] - parseFloat(obj["discount"]) + obj["vat"] 
                // obj["unit_selling_price"] = (parseFloat(obj["gross_amount"] ) - parseFloat(obj["discount"]))/parseFloat(obj["qty"])
                
                obj["inventory_item_enabled_flag"] =  line['inventory_item_enabled_flag'];

                obj["unit_price"] =  line['price'];
                obj["unit_selling_price"] = line["unit_selling_price"] || (parseFloat(obj["unit_price"])) ;
                obj["avl_qty"] =  "";
                obj["uom"] =  line['primary_unit_of_measure'];
                obj["item_desc"] =  line['description'];
                obj["item_code"] =  line['item_code'];
                obj["inventory_item_id"] =  line['inventory_item_id'];
                obj["barcode"] =  "";
                obj["no_#"] =  i+1;
                obj["action"] =  "";
                obj["line_error"] =  null;
                obj["category"] = line['category'];

                self.lines_data.push(obj);
            });
            self.lines_data.push(self.getEmptyLineObj());
            

            self.$nextTick(function(){
                self.setCollectionAmountForCA();
            })
        },
        onPasteItemStock(col,obj,evt){
            // col;
            if(col.data != 'item_code') return;
            window.gloPastingFlag = true; 
            console.log(evt);
            var self = this;
            console.log('on paste', evt.clipboardData.getData('text'));

            pastedData = evt.clipboardData.getData('text');

            if (!pastedData.includes('\n')) {
                pastedData += '\n';
                // return;   
            }

          

            // debugger;
            var pastedArr = pastedData.split('\n').map((x,i)=>{
                var arr= x.replace("\r","").split("\t").map(x=>x.trim());
                var obj = {};
                // alert(arr.length);
                obj['item_code'] = arr[0];  
                if (arr.length > 1)
                    obj['qty'] = arr[1];
                else
                    obj['qty'] = 1;

                if (arr.length > 2)
                    obj['sp'] = arr[2].split(",").join("");
                else 
                    obj['sp'] = "";
                return obj;
            })




            var data = pastedData.split("\n").filter(x=> x!="").map(x=> !x.trim().includes("\t") ? x.trim()+'~1' :x.trim().split("") );


            items = pastedArr.filter(x=>x.item_code !="").map(x=> `${x.item_code}~${x.qty}`);

            quantity = items.map(text=> ({ [text.split("~")[0]]:{quantity:text.split("~")[1]} })).reduce ((a,b) => Object.assign(a,b),{})

            NewArray = items.filter(x=>true);


            
            ShowDIV(['Getting Item info...'])
            axios.get("/saleswores/search_items?order_type_id="+$('#order_type_lov_item_page').val()+"&items="+encodeURIComponent(NewArray))
            .then(function(res)
            {
                HideDIV();
                setTimeout(function(){
                    window.gloPastingFlag = false; 
                },2000)

                res.data.data.forEach(obj=>{
                    obj.quantity = quantity[obj.item_code].quantity;
                });


                


                var lines_to_add = res.data.data.concat(
                    res.data.not_found.map(x=>({item_code:x, qty:  quantity[x] }))
                );


                var lines_to_add_in_seq =  pastedArr.slice(0,pastedArr.length-1).map((item,i)=> {
                    var obj = lines_to_add.filter(x=>x.item_code == item.item_code)[0];
                    obj['unit_selling_price'] = item.sp ;
                    obj['qty'] = quantity[obj.item_code].quantity;
                    return obj;
                });



                // debugger;
            
                
                HideDIV();
                self.addToLines(

                    lines_to_add_in_seq,
                    $(evt.target).closest('tr').index()
                )



                self.$nextTick(function(){
                    self.updateAmountsOnCustChange();
                    self.updateGrossPriceForTable();
                })
            })
            .catch(function(err)
            {
                
                HideDIV();
                window.gloPastingFlag = true; 
            })
        },
        relatedItems(obj){
            ShowDIV(['Get Related items...'])
            $('#related_item_tbl tbody tr').remove();
            let cur_item_invid = obj.inventory_item_id
            axios.get("/saleswores/get_related_item/"+cur_item_invid).then(function(res)
                        {
                            HideDIV();
                            console.log('res====>',res);
                            self.related_lines_data = res.data
                            console.log('self.related_lines_data=====>',self.related_lines_data)

                            self.related_lines_data.forEach(function (obj, tIndex) {
                                console.log('data---->', tIndex, obj);
                                $('#related_item_tbl tbody').append('<tr><td><button class="btn-sm btn-info replaceItem" data-itemcode="'+obj.ITEM_CODE+'" data-replaceitem="'+cur_item_invid+'" data-avlqty="'+obj.ONHAND_QTY+'" data-unitprice="'+obj.SALE_PRICE+'"> Replace </button></td>\
                                    <td>'+obj.ITEM_CODE+'</td>\
                                    <td>'+obj.ONHAND_QTY+'</td>\
                                    <td>'+obj.DESCRIPTION+'</td>\
                                    <td>'+obj.UOM_CODE+'</td>\
                                    <td>'+obj.SALE_PRICE+'</td></tr>');
                                
                            });

                                
                            $("#related_item_modal").show()
                        }).catch(function(){
                            HideDIV();
                        })
        },
        replaceItem(replaceitem,new_itemcode,avlqty,unitprice){
            ShowDIV(['Replacing item...'])
            axios.get("/saleswores/search_items?order_type_id="+$('#order_type_lov_item_page').val()+"&items="+new_itemcode+'~1')
            .then(function(res)
            {
                HideDIV();
                let op_data = res.data.data
                $.each(op_data, function(index, value) {
                        
                    let line = value
                    line['price'] = unitprice
                    var obj = itemLinesEntry.getEmptyLineObj();
                    obj["vat"] = parseFloat(self.customer_vat_perc) * parseFloat(line['price']);
                    obj["discount_perc"] =  0.0;
                    obj["discount"] =  line['discount'] || 0.0;
                    obj["qty"] =  line['quantity'] || 1;
                    obj["gross_amount"] =  parseFloat(obj["qty"]) * parseFloat(line['price']);
                    obj["line_total"] =  obj["gross_amount"] - parseFloat(obj["discount"]) + obj["vat"] 
                    obj["unit_price"] =  line['price'];
                    obj["avl_qty"] =  avlqty;
                    obj["uom"] =  line['primary_unit_of_measure'];
                    obj["item_desc"] =  line['description'];
                    obj["item_code"] =  line['item_code'];
                    obj["inventory_item_enabled_flag"] =  line['inventory_item_enabled_flag'];
                    obj["inventory_item_id"] =  line['inventory_item_id'];

                    obj["unit_selling_price"] = line['price'];
                    // obj["unit_selling_price"] = (parseFloat(obj["gross_amount"] ) - parseFloat(obj["discount"]))/parseFloat(obj["qty"])
                    obj["barcode"] =  "";
                    obj["no_#"] =  $(event).closest('tr').index()+1;
                    obj["action"] =  "";
                    obj["line_error"] =  null;
                    obj["category"] = line['category'];
                    obj["related_flag"] = 'N';
                    console.log('obj=====>',obj)

                    let cur_item_index =  (itemLinesEntry.lines_data).findIndex(item => item.inventory_item_id == replaceitem);
                    itemLinesEntry.lines_data.splice(cur_item_index,1,obj);
                });
                
                
                $("#related_item_modal").hide()

            })
            .catch(function()
            {
                HideDIV();


            })
        }
    },
    mounted(){
        $('#entry-new').removeClass('d-none')
        self = this
        self.fromQuotation = window.location.search.includes('type=notasalesorder')
        $(document).on('click','.replaceItem',function(e){
            let new_itemcode = $(e.target).data('itemcode')
            let replaceitem = $(e.target).data('replaceitem')
            let avlqty = $(e.target).data('avlqty')
            let unitprice = $(e.target).data('unitprice')
            
            self.replaceItem(replaceitem,new_itemcode,avlqty,unitprice)
        } );
        $(document).on('click','.related_modal_close',function(e){
            $("#related_item_modal").hide()
        } );

        
    
        
    }
})

var glo_customer_classification="";
function onPreview(previewFlag){
    $('[data-toggle="popover"]').popover('hide');


    if (previewFlag){
   
        if ($('tbody td[data-column="avl_qty"].text-danger').not('td[data-column="avl_qty"]').length != 0 ){
            return ;
        }
        
        if ($('#searchCust').val() == null){
            return ;
            
        }
    }





    itemLinesEntry.$nextTick(()=>{
        $('[data-toggle="popover"]').popover()
        })
    itemLinesEntry.showPreview = previewFlag;
    if (previewFlag){
        $('.on-preview-ui').show();
        $('.not-on-preview-ui').hide();
        $('#order_type_lov_item_page').trigger('change');

        $("#invoice_total_v").find('select,input,textarea').prop('disabled',true);

        if (parseFloat($('tfoot [data-column="discount_perc"] ').text()||0 ) >= 40 ){

            if (! ['GOVT_SEMI_GOVT','SEMI_GOVT','GOVERNMENT'].includes(glo_customer_classification.trim())){
                $('.document-upload-section').removeClass('d-none');

                axios.get("{% url 'invoice:getCustDocs' %}?c="+$('#searchCust').val()+'&o='+glo_order_number)
                .then(function(res){
                    $('#cust-docs').empty().append(res.data);
                })
            }

        }






        if ($('#order_type_lov_item_page').select2('data')[0].text.includes("-CA-")){
            get_draft_data(true);
        }

        itemLinesEntry.removeNotFound();
        
    } else {
        $("#invoice_total_v").find('select,input,textarea').prop('disabled',false);
        
        $('.on-preview-ui').hide();
        $('.not-on-preview-ui').show();
        $('.document-upload-section').addClass('d-none');
        glo_total_AMT_ASSIGNED = 0;

    }
}
    
// function handlePaste(e) {
//   var clipboardData, pastedData;

//   // Stop data actually being pasted into div
//   e.stopPropagation();
//   e.preventDefault();

//   // Get pasted data via clipboard API
//   clipboardData = e.clipboardData || window.clipboardData;
//   pastedData = clipboardData.getData('Text');

//   // Do whatever with pasteddata
// //   alert(pastedData);
//   var data = pastedData.split("\n").filter(x=> x!="").map(x=> !x.trim().includes("\t") ? x.trim()+'/1' :x.trim() );
    
//     items = data.map(text=>text.replace("\t","/"));

//     quantity = items.map(text=> ({ [text.split("/")[0]]:{quantity:text.split("/")[1]} })).reduce ((a,b) => Object.assign(a,b),{})

//     NewArray = items.filter(x=>true);

//     ShowDIV(['Getting Item info...'])
//     axios.get("/saleswores/search_items?&items="+NewArray)
//     .then(function(res)
//     {
//         HideDIV();
//         itemLinesEntry.addToLines(res.data.data);


//         console.log(res.data);
//     })
//     .catch(function(err)
//     {
//         HideDIV();
//     })

// }




function print_invoice(order_number){
   // html = '<div id="print-div" class="p-5" style="width: auto; height: auto;"></div>'
   ShowDIV()
   axios.get("/invoice/order_print/?order_number="+order_number).then(function(res)
            {
               console.log(res.data)
               console.log(res.data.data)
               pdf_data = res.data.data
               console.log('pdf_data--->',pdf_data)
               axios({
                  method: 'post',
                  url: `{% url 'setup:template-api' %}`,
                  data: pdf_data,
               }).then(function(response) {

                  HideDIV()

                  if (response.data.html){
                     $('#view-template-container').removeClass('d-none');
                     $('#print-div').removeClass('d-none');
                     $('#print-div').empty().append(response.data.html)
                     printPDF(response.data.html, 'print-div',`SO#${order_number}.pdf`)
                  }else{
                     const url = window.URL.createObjectURL(new Blob([response.data]));
                     const link = document.createElement('a');
                     link.href = url;
                     link.setAttribute('target','_blank');
                     link.setAttribute('download', order_number+'.pdf');
                     document.body.appendChild(link);
                     link.click();
                  }
               })
            
            }).catch(function(){
                HideDIV();
            })
}


function getCartDataForLineType(){
    if (itemLinesEntry.lines_data.length == 1){
        if (Object.keys(itemLinesEntry.lines_data[0]).length == 0){
            return [];
        }
    }
    return itemLinesEntry.lines_data.slice(0,-1).map(x=> ({
                                    "obj": {
                                        "name": (x.inventory_item_id || '').toString() +"{{request.session.tenant}}",
                                        "item_code": x.item_code,
                                        "organization_id": "{{request.session.tenant}}",
                                        "from_org_name": "",
                                        "serial_number": "",
                                        "inventory_item_id": (x.inventory_item_id || '').toString(),
                                        "subinventory": "",
                                        "onhand_qty": x.avl_qty ,
                                        "barcode": "",
                                        "line_price": "",
                                        "quantity": x.qty,
                                        "price":  x.unit_selling_price  ,
                                        "list_price": x.unit_price ,
                                        "vat": x.vat,
                                        "discount": x.discount,
                                        "uom": x.uom ,
                                        "e": {
                                            "add_": "",
                                            "inventory_item_id": x.inventory_item_id,
                                            "barcode": "",
                                            "item_code": x.item_code,
                                            "description": x.item_desc,
                                            "organization_id": "{{request.session.tenant}}",
                                            "organization_name": "",
                                            "organization_code": "",
                                            "inventory_item_enabled_flag": "",
                                            "subinventory": "",
                                            "org_id": "",
                                            "price": x.unit_selling_price ,
                                            "primary_uom_code": "",
                                            "mfg_code": "",
                                            "serial_number": "",
                                            "category_name": "",
                                            "business": "",
                                            "quantity": x.qty,
                                            "reservable_qty": x.avl_qty,
                                            "ord_id": ""
                                        },
                                        // "line_type_html": "<select style=\"height: 24px;\" id=0 disabled onchange=\"selected_line_type(this,4619)\"><option value=3492 selected>AYM-SPP-SZRSP-09P-CA-EXT</option></<select>",
                                        // "selected_line_type": "3492",
                                        // "selected_line_type_text": "AYM-SPP-SZRSP-09P-CA-EXT",
                                        // "line_price_list_id": "1275155",
                                        // "line_price_list_name": null,
                                        // "req_quantity": "1",
                                        // "line_vat": 0.35,
                                        // "line_total": 7.35,
                                        // "total_vat": 0.85,
                                        // "total_discount": 0,
                                        // "total_": 17.85,
                                        // "grand_total": 17.85,
                                        // "total_excl": 17,
                                        // "dp_req": 0
                                    },
                                    "price":  x.unit_price,
                                    "count": x.qty,
                                    "total": "0.00"
                                })
    )


}


function getCartDataForCreateSO(){
    if (itemLinesEntry.lines_data.length == 1){
        if (Object.keys(itemLinesEntry.lines_data[0]).length == 0){
            return [];
        }
    }
    return itemLinesEntry.lines_data.slice(0,-1).map(x=> ({
                                    "obj": {
                                        "name": (x.inventory_item_id || '').toString() +"{{request.session.tenant}}",
                                        "item_code": x.item_code,
                                        "organization_id": "{{request.session.tenant}}",
                                        "from_org_name": "",
                                        "serial_number": "",
                                        "inventory_item_id": (x.inventory_item_id || '').toString(),
                                        "subinventory": "",
                                        "onhand_qty": x.avl_qty ,
                                        "barcode": "",
                                        "line_price": "",
                                        "quantity": x.qty,
                                        "price":  x.unit_selling_price ,
                                        "list_price": x.unit_price ,
                                        "vat": x.vat,
                                        "discount": x.discount,
                                        "uom": x.uom ,
                                        "e": {
                                            "add_": "",
                                            "inventory_item_id": x.inventory_item_id,
                                            "barcode": "",
                                            "item_code": x.item_code,
                                            "description": x.item_desc,
                                            "organization_id": "{{request.session.tenant}}",
                                            "organization_name": "",
                                            "organization_code": "",
                                            "inventory_item_enabled_flag": "",
                                            "subinventory": "",
                                            "org_id": "",
                                            "price": x.unit_selling_price ,
                                            "primary_uom_code": "",
                                            "mfg_code": "",
                                            "serial_number": "",
                                            "category_name": "",
                                            "business": "",
                                            "quantity": x.qty,
                                            "reservable_qty": x.avl_qty,
                                            "ord_id": ""
                                        },
                                        "line_type_html": "",
                                        "selected_line_type": x.selected_line_type,
                                        "selected_line_type_text": x.selected_line_type_text,
                                        "line_price_list_id": x.line_price_list_id,
                                        "line_price_list_name": x.line_price_list_name,
                                        "req_quantity": x.qty,
                                        "line_vat": x.vat,
                                        "line_total":x.line_total,
                                        "total_vat": itemLinesEntry.column_aggregates['vat'],
                                        "total_discount": itemLinesEntry.column_aggregates['discount'],
                                        "total_":  itemLinesEntry.column_aggregates['line_total'],
                                        "grand_total": itemLinesEntry.column_aggregates['line_total'],
                                        "total_excl": (itemLinesEntry.column_aggregates['line_total'] - itemLinesEntry.column_aggregates['vat']).toFixedRound(2),
                                        "dp_req": 0
                                    },
                                    "price":  x.unit_price,
                                    "count": x.qty,
                                    "total": "0.00"
                                })
    )


}


function onCustDiscChange(e){
    var value = parseFloat(e.value);
    itemLinesEntry.applyDiscount();
}


function scrollToElement(id) {
    try {
        document.getElementById(id).scrollIntoView({ behavior: "smooth", block: "end", inline: "nearest" });
    } catch (error) {
        
    }
}


</script>






{% endblock %}